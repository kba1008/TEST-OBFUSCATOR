<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pelawat & Kehadiran v23.0 (Fixed Logic)</title>
    
    <script>
        // 1. Masukkan Link Google Apps Script (Web App URL) di sini
        const API_URL = 'https://script.google.com/macros/s/AKfycby7EZT41FWLpDMh27qGfpfJYZEnJPs2mMqN0lS8UYSVogiofK0Xu8tG3ucX2FDybABI/exec'; 
        
        // 2. Kata Laluan untuk Admin / Manual Override
        const PASSCODE = "101010";
         
        // 3. Koordinat Lokasi (Ambil dari Google Maps)
        const SCHOOL_LAT = 5.2357556919956485; 
        const SCHOOL_LNG = 100.68345861672972; 
        
        // 4. Jarak Radius yang dibenarkan (dalam meter)
        const RADIUS_METER = 300; 

        // 5. Anti-Spam Check-Check: Berapa minit dalam kawasan baru auto-masuk? (Elak spam)
        const MINIT_ANTI_SPAM_MASUK = 0.0001; 

        // 6. Auto Checkout Delay: Berapa minit luar kawasan baru auto-keluar?
        // DIUBAH: 0.1 minit (6 saat) -> 10 minit (Untuk elak butang hilang tiba-tiba)
        const MINIT_DELAY_KELUAR = 10; 

        // 7. Jarak Reset Auto-In: Pengguna perlu keluar sejauh ini (meter) untuk aktifkan semula auto-in selepas check-out
        const RADIUS_RESET_AUTO_IN = 300; 

        // 8. KONFIGURASI JADUAL BERTUGAS & KATEGORI (PUSAT KAWALAN UTAMA)
        // Ubah masa di sini untuk kawal waktu masuk/keluar bagi setiap jabatan.
        const JADUAL_BERTUGAS = {
            "GURU":       { masuk: "07:45:00 AM", keluar: "01:30:00 PM" },
            "AKP":        { masuk: "08:00:00 AM", keluar: "04:00:00 PM" },
            "KEBERSIHAN": { masuk: "07:30:00 AM", keluar: "04:00:00 PM" },
            "PELAWAT":    { masuk: "BEBAS",       keluar: "BEBAS" }
        };

        // --------------------------------------------------------------------------------------- 
        //       ZON KOD KRITIKAL & LOGIK PENTING
        // ---------------------------------------------------------------------------------------
        
        let jamConfig = JADUAL_BERTUGAS; // Guna config local (Pantas & Bebas Data Luar)
        let isInZone = false;
        let currentDist = 0; 
        let lastLat = 0, lastLng = 0;
        let currentList = []; 
        let isSubmitting = false;
        let hasNotifiedWake = false; 
        let inZoneStart = 0; 
        let outZoneStart = 0; 
        let wakeLock = null;
        let hasNotifiedEntry = false;
        let hasNotifiedExit = false;

        function sendData(data) {
            return new Promise((resolve, reject) => {
                if (!data.clientTime) { data.clientTime = new Date().toISOString(); }
                if (!navigator.onLine) {
                    saveToQueue(data); resolve({ offline: true }); return;
                }
                // EDIT SURGICAL: Tambah 'nocache' unik & paksa 'no-store' supaya browser tidak guna respon lama
                fetch(API_URL + "?t=" + new Date().getTime(), { 
                    method: "POST", 
                    cache: "no-store", // PENTING: Halang caching response sukses terdahulu
                    body: JSON.stringify(data) 
                })
                .then(response => response.json()).then(result => { resolve({ offline: false, data: result }); })
                .catch(error => { saveToQueue(data); resolve({ offline: true }); });
            });
        }

        function saveToQueue(data) {
            if (!data.kategori) data.kategori = "PELAWAT";
            let queue = JSON.parse(localStorage.getItem('ehadir_offline_queue') || "[]");
            queue.push(data);
            localStorage.setItem('ehadir_offline_queue', JSON.stringify(queue));
        }

        function fetchConfig() {
            // FUNGSI DIUBAH SUAI: Guna data tempatan (JADUAL_BERTUGAS) terus tanpa fetch API.
            // Ini mempercepatkan loading dan membuang kebergantungan pada Google Sheets untuk config.
            let loadEl = document.getElementById('loadingConfig');
            if(loadEl) loadEl.style.display = 'none';
            if(typeof updateScheduleInfo === 'function') updateScheduleInfo(); 
        }

        // ============================================================
        // FUNGSI BARU: DOUBLE CHECK STATUS (LOGIK KETAT)
        // ============================================================
        function checkAutoStatus(list) {
            // 1. Dapatkan nama dari Session (Pengguna semasa) ATAU Locked Name (Mode Auto)
            let session = JSON.parse(localStorage.getItem('ehadir_session'));
            let lockedName = localStorage.getItem('ehadir_locked_name');
            
            // Nama sasaran yang kita nak semak
            let targetName = (session && session.nama) ? session.nama : lockedName;
            
            if (!targetName) return; // Jika tiada sesiapa login, abaikan.

            // 2. Pastikan list adalah array yang sah
            let cleanList = Array.isArray(list) ? list : (list.data || []);
            
            // 3. Cari rekod pengguna dalam senarai server terkini
            let userRecord = cleanList.find(item => item.nama === targetName);

            if (userRecord) {
                // SITUASI A: Nama JUMPA dalam senarai
                
                if (!userRecord.keluar || userRecord.keluar === "") {
                    // A1. Belum Punch Out (Masih Bertugas) -> BUTANG KELUAR MESTI ADA
                    if (!session) {
                        console.log("Auto-Restore: Server kata anda masih bertugas, tapi session hilang.");
                        // Cipta semula session untuk wujudkan butang 'Daftar Keluar'
                        localStorage.setItem('ehadir_session', JSON.stringify({
                            nama: targetName,
                            kategori: userRecord.kategori || "GURU", 
                            date: new Date().toISOString().slice(0,10),
                            avatar: localStorage.getItem('ehadir_user_avatar') || ""
                        }));
                        location.reload(); // Refresh untuk lock butang keluar
                    }
                } else {
                    // A2. Sudah Punch Out (Dah Balik) -> BUTANG KELUAR MESTI HILANG
                    if (session) {
                         console.log("Auto-Logout: Server kata anda sudah keluar.");
                         localStorage.removeItem('ehadir_session');
                         location.reload(); // Refresh untuk kembali ke menu utama
                    }
                }
            } else {
                // SITUASI B: Nama TIADA dalam senarai (Contoh: Data hari baru / Admin delete)
                // Jika session masih ada, kita mesti buang (Sebab user tak wujud dalam senarai hari ini)
                if (session) {
                     console.log("Auto-Logout: Nama tiada dalam senarai server.");
                     localStorage.removeItem('ehadir_session');
                     location.reload();
                }
            }
        }

        async function hantarMasuk(isAuto = false) {
            if(isSubmitting) return;
            // LOGIK BARU: RESET SESSION DAHULU
            if(!isAuto) {
                localStorage.removeItem('ehadir_session');
                localStorage.removeItem('ehadir_auto_in_blocked');
            }

            // EDIT SURGICAL: STRICT FILTER & ANTI-FAKE GPS
            if(!isInZone) { 
                if(isAuto) return; // Auto diam jika luar kawasan
                showModernAlert("Luar Kawasan", "Anda berada di luar zon yang dibenarkan (" + Math.round(currentDist) + "m).", "error");
                return;
            }
            
            let nama, kat;
            if (isAuto) {
                nama = localStorage.getItem('ehadir_locked_name');
                kat = localStorage.getItem('ehadir_locked_kat');
            }
            else {
                nama = document.getElementById('nama').value.toUpperCase().trim();
                kat = document.getElementById('kategori').value;
            }

            let alasan = "AUTO CHECK-IN (GPS)";
            let now = new Date();

            if (!nama || !kat) { 
                if(!isAuto) showModernAlert("Data Tidak Lengkap", "Isi Nama dan Kategori.", "error");
                return; 
            }

            isSubmitting = true;
            if(!isAuto) { 
                // STEP: FILTER ANTI-FAKE GPS (SAMPLING)
                document.getElementById('btnMainSubmit').disabled = true;
                document.getElementById('btnMainSubmit').innerHTML = 'MENYEMAK GPS...'; 

                try {
                    await new Promise((resolve, reject) => {
                        let samples = [];
                        let required = 3; 
                        let w = navigator.geolocation.watchPosition(p => {
                            samples.push({lat: p.coords.latitude, lng: p.coords.longitude});
                            document.getElementById('btnMainSubmit').innerHTML = `ANALISIS INTEGRITI (${samples.length}/${required})...`;
                            
                            if(samples.length >= required) {
                                navigator.geolocation.clearWatch(w);
                                
                                // A. Cek Static (Fake GPS selalunya statik)
                                let first = JSON.stringify(samples[0]);
                                let isStatic = samples.every(s => JSON.stringify(s) === first);
                                
                                // B. Cek Jarak Terkini
                                let last = samples[samples.length-1];
                                let d = calcDist(last.lat, last.lng, SCHOOL_LAT, SCHOOL_LNG);
                                
                                if(d > RADIUS_METER) reject(`Lokasi tidak sah! Jarak: ${Math.round(d)}m`);
                                else if(isStatic) reject("GPS Statik Dikesan (Anti-Fake). Sila bergerak sedikit.");
                                else {
                                    lastLat = last.lat;
                                    lastLng = last.lng; // Update global
                                    resolve();
                                }
                            }
                        }, err => {
                            navigator.geolocation.clearWatch(w);
                            reject(err.message);
                        }, {enableHighAccuracy: true, maximumAge: 0, timeout: 5000});
                    });
                } catch(e) {
                    showModernAlert("Gagal Masuk", e, "error");
                    isSubmitting = false;
                    document.getElementById('btnMainSubmit').disabled = false;
                    document.getElementById('btnMainSubmit').innerHTML = `<img src="https://cdn-icons-png.flaticon.com/128/9402/9402342.png" class="icon-3d-std"> DAFTAR MASUK (MANUAL)`;
                    return;
                }

                document.getElementById('btnMainSubmit').innerHTML = 'SEDANG HANTAR...';
            }

            try {
                let savedAvatar = localStorage.getItem('ehadir_user_avatar') || "";
                // Generate NEW uniqueID setiap kali masuk untuk elak duplicate reject
                let uniqueID = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                const payload = { action: "MASUK", passcode: PASSCODE, nama: nama, kategori: kat, alasan: alasan, lat: lastLat, lng: lastLng, clientTime: now.toISOString(), uuid: uniqueID, avatar: savedAvatar };
                const result = await sendData(payload);

                if (result.offline) {
                    if(!isAuto) showModernAlert("Mod Offline", "Data disimpan dalam telefon.", "info");
                    // Offline mode diteruskan macam biasa
                    localStorage.setItem('ehadir_session', JSON.stringify({nama: nama, kategori: kat, date: now.toISOString().slice(0,10), uuid: uniqueID, avatar: savedAvatar}));
                    localStorage.removeItem('ehadir_auto_in_blocked');
                    location.reload();
                } else {
                    // STRICT CHECK: Double Check Google Sheet (Column E Logic)
                    if (result.data && result.data.result === "success") {
                        if(isAuto) {
                            showSyncBar("SELAMAT DATANG KE SK SELAMA (K)", "#27ae60");
                            localStorage.setItem('ehadir_session', JSON.stringify({nama: nama, kategori: kat, date: now.toISOString().slice(0,10), uuid: uniqueID, avatar: savedAvatar}));
                            localStorage.removeItem('ehadir_auto_in_blocked');
                            location.reload();
                        } else {
                             // MANUAL MODE: VERIFY DAHULU SEBELUM SUCCESS
                             document.getElementById('btnMainSubmit').innerHTML = 'SAHKAN DATA (DB)...';
                             await verifyAndFinalize(nama, kat, uniqueID, savedAvatar);
                        }
                    } else {
                         // Jika server return error atau unknown status
                         let msg = (result.data && result.data.msg) ? result.data.msg : "Data gagal masuk ke Google Sheet. Sila cuba lagi.";
                         if(!isAuto) showModernAlert("Gagal", msg, "error");
                         isSubmitting = false;
                         document.getElementById('btnMainSubmit').disabled = false;
                         document.getElementById('btnMainSubmit').innerHTML = `<img src="https://cdn-icons-png.flaticon.com/128/9402/9402342.png" class="icon-3d-std"> DAFTAR MASUK (MANUAL)`;
                    }
                }

            } catch (error) {
                console.error("Ralat:", error);
                isSubmitting = false;
                if(!isAuto) document.getElementById('btnMainSubmit').disabled = false;
            }
        }

        async function verifyAndFinalize(nama, kat, uuid, avatar, attempt = 1) {
             if(attempt > 5) {
                 showModernAlert("Masa Tamat", "Data dihantar tetapi server lambat respon. Sila semak senarai manual.", "info");
                 isSubmitting = false;
                 document.getElementById('btnMainSubmit').disabled = false;
                 document.getElementById('btnMainSubmit').innerHTML = `<img src="https://cdn-icons-png.flaticon.com/128/9402/9402342.png" class="icon-3d-std"> DAFTAR MASUK (MANUAL)`;
                 return;
             }
             
             await new Promise(r => setTimeout(r, 2000));
             try {
                 let response = await fetch(API_URL, { method: "POST", body: JSON.stringify({action: "GET_LIST", passcode: PASSCODE}) });
                 let json = await response.json();
                 let list = json.data || json;
                 // Cek jika nama ada DAN masa (Kolum E/jam) wujud
                 let record = list.find(item => item.nama === nama && item.jam && item.jam !== "");
                 if (record) {
                     showModernAlert("Berjaya", "Data disahkan masuk dalam sistem!", "success");
                     localStorage.setItem('ehadir_session', JSON.stringify({nama: nama, kategori: kat, date: new Date().toISOString().slice(0,10), uuid: uuid, avatar: avatar}));
                     localStorage.removeItem('ehadir_auto_in_blocked');
                     setTimeout(() => location.reload(), 1500);
                 } else {
                     document.getElementById('btnMainSubmit').innerHTML = `SAHKAN DATA (${attempt}/5)...`;
                     await verifyAndFinalize(nama, kat, uuid, avatar, attempt + 1);
                 }
             } catch(e) {
                 console.log("Verify Error", e);
                 await verifyAndFinalize(nama, kat, uuid, avatar, attempt + 1);
             }
        }

        async function hantarKeluar(isAuto = false) {
            if(isSubmitting) return;
            let session = JSON.parse(localStorage.getItem('ehadir_session'));
            if (!session || !session.nama) { return; } // Safety check
            
            let alasanValue = isAuto ? "AUTO CHECKOUT (KELUAR KAWASAN)" : "PULANG (MANUAL)";
            let sessionUUID = session.uuid || "";
            let proceed = async () => {
                isSubmitting = true;
                if(!isAuto) { document.getElementById('btnKeluar').disabled = true; document.getElementById('btnKeluar').innerText = "PROSES RESET..."; }

                try {
                    const payload = { action: "KELUAR", passcode: PASSCODE, nama: session.nama.toUpperCase(), alasan: alasanValue, lat: lastLat, lng: lastLng, clientTime: new Date().toISOString(), uuid: sessionUUID };
                    // EDIT SURGICAL: KELUAR TIDAK PERLU CEK SERVER. Fire & Forget.
                    await sendData(payload);
                    // Terus reset local session tanpa menunggu 'success' server.
                    if(isAuto) {
                        showSyncBar("SEMOGA SELAMAT DALAM PERJALANAN ANDA", "#c0392b");
                    }
                    
                    // Reset Total Session
                    localStorage.setItem('ehadir_auto_in_blocked', 'true');
                    localStorage.removeItem('ehadir_session');
                    
                    // Delay sedikit untuk pastikan storage clear sebelum reload
                    setTimeout(() => location.reload(), 500);
                } catch (error) {
                    // Jika error rangkaian pun, force logout tetap jalan
                    console.error(error);
                    localStorage.removeItem('ehadir_session');
                    location.reload();
                }
            };
            if(!isAuto) {
                showModernAlert("Pengesahan", "Daftar keluar sekarang?", "confirm", proceed);
            } else {
                proceed();
            }
        }

        function keluarManual(namaUser) {
            let pass = prompt("ADMIN: Passcode untuk keluarkan " + namaUser + ":");
            if (pass !== PASSCODE) { showModernAlert("Gagal", "Passcode salah.", "error"); return; }
            
            sendData({ action: "KELUAR", passcode: PASSCODE, nama: namaUser, alasan: "Manual Admin", lat: lastLat, lng: lastLng, clientTime: new Date().toISOString() })
            .then(res => { loadList(); });
        }

        async function hantarPelawat() {
            if(isSubmitting) return;
            let foto = document.getElementById('base64Foto').value;
            let namaPelawat = document.getElementById('namaPelawatInput').value.toUpperCase();
            if (!foto) { showModernAlert("Tiada Gambar", "Ambil gambar dahulu.", "error"); return; }
            if (!namaPelawat) { showModernAlert("Tiada Nama", "Isi nama pelawat.", "error"); return; }
            isSubmitting = true;
            document.getElementById('btnPelawatSubmit').disabled = true;
            document.getElementById('btnPelawatSubmit').innerText = "SEDANG HANTAR...";
            try {
                const payload = { action: "MASUK", passcode: PASSCODE, kategori: "PELAWAT", nama: namaPelawat, fotoBase64: foto, lat: lastLat, lng: lastLng, clientTime: new Date().toISOString() };
                let result = await sendData(payload);
                if(result.offline || (result.data && result.data.result === "success")) {
                    showModernAlert("Berjaya", "Data pelawat diterima.", "success");
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showModernAlert("Gagal", "Server menolak data.", "error");
                    isSubmitting = false;
                    document.getElementById('btnPelawatSubmit').disabled = false;
                }
            } catch (error) {
                console.error(error);
                isSubmitting = false;
            }
        }

        function monitorAutoLogic() {
            let MS_IN_DELAY = (typeof MINIT_ANTI_SPAM_MASUK !== 'undefined' ? MINIT_ANTI_SPAM_MASUK : 5) * 60 * 1000;
            let MS_OUT_DELAY = (typeof MINIT_DELAY_KELUAR !== 'undefined' ? MINIT_DELAY_KELUAR : 10) * 60 * 1000;

            let session = JSON.parse(localStorage.getItem('ehadir_session'));
            let locked = localStorage.getItem('ehadir_locked_name');
            let lockedKat = localStorage.getItem('ehadir_locked_kat');
            let now = Date.now();

            let statusEl = document.getElementById('statusText');
            let isBlocked = localStorage.getItem('ehadir_auto_in_blocked');
            if (isInZone) {
                 let icon = "<img src='https://cdn-icons-png.flaticon.com/128/190/190411.png' class='icon-3d-mini'>";
                 if(statusEl) {
                     statusEl.innerHTML = icon + " DALAM KAWASAN (" + Math.round(currentDist) + "m)";
                     statusEl.style.color = "#27ae60";
                     statusEl.style.background = "#e8f5e9";
                 }
                 
                 if (isBlocked) {
                     if(statusEl) statusEl.innerHTML += `<br><span style="font-size:9px; color:#e67e22;">AUTO-IN OFF (KELUAR > ${RADIUS_RESET_AUTO_IN}M UNTUK RESET)</span>`;
                     return; 
                 }
            } else {
                 let icon = "<img src='https://cdn-icons-png.flaticon.com/128/190/190406.png' class='icon-3d-mini'>";
                 if(statusEl) {
                     statusEl.innerHTML = icon + " LUAR KAWASAN (" + Math.round(currentDist) + "m)";
                     statusEl.style.color = "#c0392b";
                     statusEl.style.background = "#fdeea5";
                 }
            }

            if (isInZone) {
                let wBox = document.getElementById('warningBox');
                if(wBox) wBox.style.display = "none";
                hasNotifiedExit = false; 
                
                if (!session && locked && lockedKat && !hasNotifiedEntry) {
                    hasNotifiedEntry = true;
                    sendNotification("ANDA SUDAH SAMPAI!", "Sila klik di sini untuk buka aplikasi", "wake-up-entry");
                }

                if (!session && locked && lockedKat && !isSubmitting) {
                    if (inZoneStart > 0) {
                        let elapsed = now - inZoneStart;
                        let remainingSec = Math.ceil((MS_IN_DELAY - elapsed) / 1000);
                        
                        if(statusEl) statusEl.innerHTML += ` <br>[AUTO-PUNCH: ${remainingSec}s]`;
                        if (remainingSec <= 0) {
                            hantarMasuk(true);
                            inZoneStart = 0; 
                        }
                    }
                }
            } 
            else {
                hasNotifiedEntry = false;
                if (session && !hasNotifiedExit) {
                    hasNotifiedExit = true;
                    sendNotification("ANDA TELAH KELUAR KAWASAN!", "Anda dikesan telah meninggalkan pejabat. Klik di sini untuk sahkan waktu balik (Punch Out).", "wake-up-exit");
                }

                if (session && !isSubmitting) {
                     if (outZoneStart > 0) {
                         let elapsed = now - outZoneStart;
                         let remainingSec = Math.ceil((MS_OUT_DELAY - elapsed) / 1000);
                         
                         let warnBox = document.getElementById('warningBox');
                         if(warnBox) {
                             warnBox.style.display = "block";
                             warnBox.innerHTML = `AMARAN! KELUAR ZON.<br>AUTO PUNCH-OUT DALAM <span style="font-size:1.5em">${remainingSec}</span> S`;
                         }

                         if (remainingSec <= 0) {
                             hantarKeluar(true);
                             outZoneStart = 0;
                         }
                     }
                } else {
                     let wBox = document.getElementById('warningBox');
                     if(wBox) wBox.style.display = "none";
                }
            }
        }

        function startRadar() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    lastLat = pos.coords.latitude; lastLng = pos.coords.longitude;
                    currentDist = calcDist(lastLat, lastLng, SCHOOL_LAT, SCHOOL_LNG); 
                    isInZone = (currentDist <= RADIUS_METER);
                    if (currentDist > RADIUS_RESET_AUTO_IN) {
                        localStorage.removeItem('ehadir_auto_in_blocked');
                    }
                    if (isInZone) {
                        if (!inZoneStart) inZoneStart = Date.now();
                        outZoneStart = 0; 
                    } else {
                        if (!outZoneStart) outZoneStart = Date.now();
                        inZoneStart = 0; 
                    }
                }, null, {enableHighAccuracy: true, maximumAge: 0, timeout: 5000});
            }
        }

        function calcDist(a,b,c,d){var R=6371e3,x=a*Math.PI/180,y=c*Math.PI/180,k=(c-a)*Math.PI/180,l=(d-b)*Math.PI/180,z=Math.sin(k/2)*Math.sin(k/2)+Math.cos(x)*Math.cos(y)*Math.sin(l/2)*Math.sin(l/2);return R*2*Math.atan2(Math.sqrt(z),Math.sqrt(1-z));}

        async function initBackgroundService() {
            if ("Notification" in window) {
                 if(Notification.permission !== "granted") {
                      await Notification.requestPermission();
                 }
            }
            if ('wakeLock' in navigator) {
                const requestLock = async () => {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        let am = document.getElementById('autoModeIndicator');
                        if(am) am.style.display = 'block';
                        wakeLock.addEventListener('release', () => { console.log('Wake Lock Released'); });
                    } catch (err) { console.error(`${err.name}, ${err.message}`); }
                };
                await requestLock();
                document.addEventListener('visibilitychange', async () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        await requestLock();
                    } else {
                        await requestLock();
                    }
                });
            }
        }
    </script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3c72">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif;
            background: #f0f2f5; color: #333; margin: 0; padding: 15px; display: flex; justify-content: center; min-height: 100vh;
        }
        .container { background: white; padding: 0; border-radius: 25px; width: 100%; max-width: 420px;
            text-align: center; position: relative; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; padding-bottom: 30px;
        }
        
        .header-bg { background: linear-gradient(to right, #141e30, #243b55);
            padding: 15px 20px 30px 20px; color: white; border-radius: 0 0 25px 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 25px;
            position: relative; }
        .top-bar-row { display: flex; justify-content: center; align-items: center; gap: 10px;
            font-size: 11px; color: #cfd8dc; font-weight: 400; letter-spacing: 0.5px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; white-space: nowrap; text-transform: uppercase;
        }
        
        .main-title-block { display: flex;
            flex-direction: column; align-items: center; }
        .title-small { font-size: 10px; letter-spacing: 3px; text-transform: uppercase;
            color: #6dd5ed; margin-bottom: 5px; font-weight: 600; }
        .title-big { font-size: 24px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px; line-height: 1.1; background: -webkit-linear-gradient(#fff, #a8c0ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            margin: 2px 0; }

        .content-padding { padding: 0 20px;
        }
        select, input, textarea { width: 100%; padding: 14px; margin-bottom: 12px;
            border: 2px solid #f1f3f5; background: #f8f9fa; border-radius: 12px; font-size: 14px; box-sizing: border-box; font-family: inherit; outline: none; transition: 0.3s; color: #333;
        }
        select:focus, input:focus { border-color: #1e3c72; background: #fff;
        }
        textarea { resize: vertical; min-height: 80px; display: none; border: 2px solid #f39c12;
            background: #fffcf5; } /* HIDDEN ALASAN */

        /* === NEW CSS FOR NAME LOCK & AVATAR === */
        .input-group { position: relative;
            display: flex; align-items: center; width: 100%; margin-bottom: 12px; }
        /* Tambah padding right supaya dua butang muat */
        .input-group input { margin-bottom: 0;
            padding-right: 90px; }
        
        .lock-btn { position: absolute;
            right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; background: #ecf0f1; border: none; z-index: 5; padding: 6px; border-radius: 50%; transition: 0.2s;
            width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
        }
        .lock-btn:hover { background: #dfe6e9;
        }
        .lock-btn:active { transform: translateY(-50%) scale(0.9);
        }
        .lock-btn:disabled { opacity: 0.5; cursor: not-allowed;
        }
        
        .avatar-btn { right: 48px;
            background: transparent; } /* Butang avatar sebelah butang lock */

        /* Style Khas bila lock aktif (Kuning) */
        .btn-yellow { background: #f1c40f !important;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); border: 2px solid #f39c12;
        }

        /* Style Modal Avatar Grid */
        .avatar-grid { display: grid;
            grid-template-columns: repeat(5, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px;
        }
        .avatar-option { width: 100%; aspect-ratio: 1/1; cursor: pointer; border-radius: 50%;
            border: 2px solid transparent; transition: 0.2s; padding: 2px; background: #f8f9fa;
        }
        .avatar-option:hover { border-color: #1e3c72; background: #e8f5e9; transform: scale(1.1);
        }
        .avatar-option.selected { border-color: #27ae60; background: #d4edda;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.3); }
        .avatar-option img { width: 100%;
            height: 100%; object-fit: contain; }
        /* ============================== */

        .btn { width: 100%;
            padding: 16px; background: #1e3c72; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; margin-bottom: 12px;
            transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 5px 15px rgba(30,60,114,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(30,60,114,0.4); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-keluar { background: #c0392b; box-shadow: 0 5px 15px rgba(192,57,43,0.3); }
        .btn-keluar:hover { background: #e74c3c; box-shadow: 0 8px 20px rgba(192,57,43,0.4); }
        .btn-pelawat { background: #27ae60; box-shadow: 0 5px 15px rgba(39,174,96,0.3); margin-top: 5px; } 
        .btn-pelawat:hover { background: #2ecc71; box-shadow: 0 8px 20px rgba(39,174,96,0.4); }
        
        #warningBox { display: none; background: #c0392b; color: white; padding: 15px; border-radius: 12px;
            margin-bottom: 20px; font-size: 13px; font-weight: 700; animation: pulse 1.5s infinite; text-transform: uppercase; letter-spacing: 0.5px;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.02); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        
        #dashboardPanel { display: none; text-align: center; background: #f8f9fa; padding: 25px;
            border-radius: 15px; border: 1px solid #e1e4e8; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .user-welcome { font-size: 18px; font-weight: 700;
            color: #1e3c72; margin-bottom: 2px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .locked-msg { font-size: 11px; color: #95a5a6; margin-bottom: 15px;
        }
        
        #pelawatPanel { display: none; border: 2px dashed #27ae60; padding: 15px; border-radius: 15px; background: #f0fdf4; margin-bottom: 20px;
        }
        /* STYLO GIANT CAMERA CSS */
        .giant-cam-btn { width: 100%; height: 160px; background: linear-gradient(135deg, #134e5e, #71b280); border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.15); cursor: pointer; transition: 0.2s;
            border: 2px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; }
        .giant-cam-btn:active { transform: scale(0.96); }
        .giant-cam-icon { width: 70px; height: 70px;
            margin-bottom: 10px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); transition: 0.3s; }
        .giant-cam-text { color: white; font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        #previewImg { width: 100%; height: auto; border-radius: 10px; margin-top: 15px; display: none; border: 2px solid #27ae60;
        }
        
        #statusText { margin-bottom: 15px; font-size: 11px; font-weight: 600; padding: 8px 15px; border-radius: 20px;
            display: inline-block; background: #e0e0e0; color: #555; letter-spacing: 0.5px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        #autoModeIndicator { display: none; position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2);
            color: white; font-size: 9px; padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.4); backdrop-filter: blur(4px);
        }
        
        .list-container { margin-top: 0; text-align: left; max-height: 400px; overflow-y: auto;
            border-top: 1px solid #eee; background: #fff; }
        .list-item { padding: 12px 20px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; transition: background 0.1s; }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: #f9f9f9; }
        
        .list-header { background: #f1f3f5; padding: 10px 20px; font-size: 12px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e1e4e8; border-radius: 12px 12px 0 0; margin-top: 25px;
        }
        
        .user-info-row { display: flex; align-items: center; gap: 10px; }
        .user-avatar-small { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; background: white; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; color: #333; font-size: 13px; }
        .user-cat { font-size: 10px; color: #999; margin-top: 1px; }
        
        .time-badge { background: #e8f5e9; color: #27ae60; padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 11px;
            display: inline-flex; align-items: center; gap: 4px; }
        .time-out { background: #ffebee; color: #c0392b; }
        .offline-badge { background: #95a5a6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-left: 5px; }
        
        .jam-keluar-display { font-size: 10px; color: #7f8c8d; margin-top: 3px; display: block; text-align: right; font-weight: 500; }
        
        .admin-controls { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; display: flex; gap: 10px; justify-content: flex-end; }
        .admin-btn-small { background: #ecf0f1; border: none; border-radius: 6px; padding: 5px 10px; font-size: 10px; cursor: pointer; color: #2c3e50; font-weight: 600;
            display: inline-flex; align-items: center; gap: 4px; font-size: 11px; }
        .list-actions { display: flex; gap: 5px; align-items: center; flex-shrink: 0;
        }
        .icon-btn { cursor: pointer; font-size: 14px; width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            background: #f8f9fa; border: 1px solid #eee; transition: background 0.2s; }
        .icon-btn:hover { background: #e2e6ea; }
        
        #scheduleInfo { display: none;
            background: transparent; padding: 0; margin-bottom: 15px; text-align: center; }
        .schedule-minimal { display: flex; justify-content: center; gap: 10px; align-items: center;
        }
        /* UBAH SUAI UI: Time Pill yang lebih moden dan canggih */
        .time-pill { background: rgba(255, 255, 255, 0.95);
            padding: 10px 18px; border-radius: 30px; font-size: 11px; font-weight: 700; display: flex; align-items: center; gap: 8px; border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); backdrop-filter: blur(5px); transition: transform 0.2s; }
        .time-pill:hover { transform: translateY(-2px);
        }
        
        /* Animasi Pop-In untuk visual canggih */
        .pop-in { animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8) translateY(-10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        
        /* Modal Image */
        #imageModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; }
        #imgFull { max-width: 90%; max-height: 80%; border-radius: 10px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .close-modal { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; font-weight: bold; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        
        /* 3D Icons Support */
        .icon-3d-mini { width: 16px; height: 16px; vertical-align: text-bottom; margin-right: 4px; }
        .icon-3d-std { width: 20px; height: 20px; vertical-align: middle; margin-right: 6px; }
        .icon-3d-lg { width: 32px; height: 32px; vertical-align: middle; }
        .icon-3d-xl { width: 64px; height: 64px; margin-bottom: 10px;
        }
        
        @keyframes spin3d { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg);
        } }
        .spin-3d { animation: spin3d 2s linear infinite; }
        
        #customModal, #avatarModalContainer { display: none; position: fixed; z-index: 10000;
            left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center; animation: fadeIn 0.3s;
        }
        .custom-modal-content { background: white; padding: 30px 25px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); transform: scale(0.9); animation: popUp 0.3s forwards; }
        @keyframes popUp { to { transform: scale(1);
        } }
        .modal-icon-top { font-size: 50px; margin-bottom: 15px; display: block; }
        .modal-title { font-size: 18px; font-weight: 700; color: #2c3e50;
            margin-bottom: 10px; }
        .modal-msg { font-size: 13px; color: #555; margin-bottom: 20px; line-height: 1.5; }
        .modal-btn-row { display: flex; gap: 10px;
            justify-content: center; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 13px;
        }
        .btn-ok { background: #1e3c72; color: white; }
        .btn-cancel-modal { background: #ecf0f1; color: #7f8c8d;
        }
        
        /* Status Bar untuk Offline/Sync */
        #syncStatusBar { display: none; position: fixed; top: 0; left: 0; width: 100%;
            padding: 10px; text-align: center; z-index: 10001; font-size: 12px; color: white; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        @media (max-width: 480px) {
            .container { border-radius: 0; min-height: 100vh; padding-bottom: 50px; }
            .header-bg { border-radius: 0 0 20px 20px; }
        }
    </style>
</head>
<body>

    <div id="syncStatusBar"></div>

    <div class="container">
        <div class="header-bg">
            <div id="autoModeIndicator">MODE AUTO</div>
            <div class="top-bar-row">
                <span id="dateDisplay">ISNIN, 1 JAN 2024</span>
                <span>&bull;</span>
                <span id="clockDisplay">00:00:00</span>
                <span>&bull;</span>
                <span id="hijriDisplay">1 RAMADAN</span>
            </div>
            
            <div class="main-title-block">
                <div class="title-small">SISTEM PENGURUSAN</div>
                <div class="title-big">E-HADIR</div>
                <div class="title-big">SK SELAMA (K)</div>
            </div>
        </div>

        <div class="content-padding">
            <div id="statusText">
                <img src="https://cdn-icons-png.flaticon.com/128/9077/9077975.png" class="icon-3d-mini spin-3d"> Mencari GPS...
            </div>
            
            <div id="dashboardPanel">
                <span class="user-welcome">
                    <img id="userAvatarDash" src="https://cdn-icons-png.flaticon.com/128/4140/4140047.png" class="icon-3d-lg">
                    Hai, <span id="sessionName">--</span>
                </span>
                <div class="locked-msg">Auto Check-In Berjaya.</div>
                
                <div id="dashboardSchedule" style="font-size:12px; color:#2c3e50; background:#fff3cd; padding:10px; border-radius:8px; margin-bottom:15px; display:none; border: 1px solid #ffeeba;">
                     Waktu Pulang Rasmi: <span id="userExitTime" style="font-weight:bold;">--:--</span>
                </div>

                <p id="dynamicStatus" style="margin:0 0 15px 0; font-size:11px; color:#27ae60; font-weight:700;
                    letter-spacing:0.5px; text-transform:uppercase;">STATUS: SEDANG BERTUGAS</p>
                
                <textarea id="alasanKeluar" style="display:none;" placeholder="Mohon nyatakan sebab pulang awal untuk makluman pentadbir..."></textarea>
                
                <button id="btnKeluar" class="btn btn-keluar" onclick="hantarKeluar(false)">
                    <img src="https://cdn-icons-png.flaticon.com/128/3580/3580154.png" class="icon-3d-std"> DAFTAR KELUAR (MANUAL)
                </button>
                
                <div style="margin-top: 20px;
                    border-top: 1px solid #eee; padding-top: 15px;">
                     <button class="btn btn-pelawat" onclick="showPelawatForm()" style="font-size:13px;
                         padding: 12px;">
                         <img src="https://cdn-icons-png.flaticon.com/128/3135/3135768.png" class="icon-3d-std"> BANTU DAFTAR PELAWAT
                     </button>
                </div>
            </div>

            <div id="defaultForm">
                <div id="loadingConfig">
                    <img src="https://cdn-icons-png.flaticon.com/128/189/189792.png" class="spin-3d" width="30">
                    <div style="font-size:10px; margin-top:5px;">Konfigurasi...</div>
                </div>

                <div id="scheduleInfo">
                     </div>
                
                <div id="warningBox"></div>

                <div class="input-group">
                    <input type="text" id="nama" placeholder="MASUKKAN NAMA ANDA (HURUF BESAR)" oninput="this.value = this.value.toUpperCase()">
                    
                    <button class="avatar-btn lock-btn" id="avatarBtn" onclick="openAvatarModal()" title="Pilih Avatar">
                         <img id="avatarIconBtn" src="https://cdn-icons-png.flaticon.com/128/4140/4140048.png" style="width:20px; height:20px;">
                    </button>

                    <button class="lock-btn" id="lockNameBtn" onclick="toggleLockName()" title="Simpan Nama">
                        <img id="lockIconImg" src="https://cdn-icons-png.flaticon.com/128/3064/3064197.png" style="width:16px; opacity:0.6;">
                    </button>
                </div>

                <select id="kategori" onchange="checkKategori()">
                    <option value="" disabled selected>PILIH KATEGORI</option>
                    <option value="GURU">GURU</option>
                    <option value="AKP">AKP</option>
                    <option value="KEBERSIHAN">PEKERJA KEBERSIHAN</option>
                    <option value="PELAWAT">PELAWAT LUAR / IBU BAPA</option>
                </select>

                <button id="btnMainSubmit" class="btn" onclick="hantarMasuk(false)">
                    <img src="https://cdn-icons-png.flaticon.com/128/9402/9402342.png" class="icon-3d-std"> DAFTAR MASUK (MANUAL)
                </button>
            </div>
            
            <div id="pelawatPanel">
                 <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                     <span style="font-weight:700; color:#27ae60; font-size:12px;">MOD PELAWAT</span>
                     <span onclick="document.getElementById('pelawatPanel').style.display='none'; document.getElementById('defaultForm').style.display='block';" style="cursor:pointer; color:#c0392b; font-weight:bold;">&times; TUTUP</span>
                 </div>
                 
                 <div class="giant-cam-btn" onclick="document.getElementById('cameraInput').click()">
                      <img src="https://cdn-icons-png.flaticon.com/128/3687/3687416.png" class="giant-cam-icon">
                      <div class="giant-cam-text">AMBIL GAMBAR</div>
                 </div>
                 
                 <img id="previewImg">
                 <input type="file" id="cameraInput" accept="image/*" capture="camera" style="display:none;" onchange="processImage(this)">
                 <input type="hidden" id="base64Foto">
                 
                 <input type="text" id="namaPelawatInput" placeholder="NAMA PENUH PELAWAT" style="margin-top:15px;" oninput="this.value=this.value.toUpperCase()">
                 
                 <button id="btnPelawatSubmit" class="btn btn-pelawat" onclick="hantarPelawat()">HANTAR DATA PELAWAT</button>
            </div>

            <div class="list-header">
                <span>
                    <img src="https://cdn-icons-png.flaticon.com/128/942/942799.png" class="icon-3d-std"> Rekod Hari Ini (<span id="count">0</span>)
                </span>
                <button onclick="loadList()" style="border:none; background:none; cursor:pointer;">
                    <img src="https://cdn-icons-png.flaticon.com/128/3031/3031718.png" class="icon-3d-std">
                </button>
            </div>
            
            <div id="listContainer" class="list-container">
                <div style="padding:20px; color:#999; font-size:12px;">Memuatkan data...</div>
            </div>
        </div>
    </div>

    <div id="imageModal" onclick="closeModal()">
        <span class="close-modal">&times;</span>
        <img id="imgFull">
    </div>

    <div id="customModal">
        <div class="custom-modal-content">
            <span id="modalIcon" class="modal-icon-top"></span>
            <div id="modalTitle" class="modal-title">Tajuk</div>
            <div id="modalMsg" class="modal-msg">Mesej di sini.</div>
            <div id="modalBtns" class="modal-btn-row"></div>
        </div>
    </div>

    <div id="avatarModalContainer">
        <div class="custom-modal-content" style="max-width:300px;">
            <div class="modal-title">Pilih Watak Anda</div>
            <div class="avatar-grid" id="avatarGrid">
                </div>
            <div class="modal-btn-row" style="margin-top:15px;">
                <button class="modal-btn btn-ok" onclick="selectAvatar()">Simpan</button>
                <button class="modal-btn btn-cancel-modal" onclick="closeAvatarModal()">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // LOGIK UI & EVENT LISTENERS
        // ==========================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => {
                    console.log('SW Berjaya:', reg.scope);
                    if ('SyncManager' in window) {
                        reg.sync.register('sync-attendance').catch(err => console.log("Sync bg gagal", err));
                    }
                }).catch(err => console.log('SW Gagal:', err));
            });
        }

        window.addEventListener('online', () => {
             console.log("Internet dikesan! Memulakan sinkronisasi...");
             showSyncBar("Internet Kembali Pulih. Menyegerakkan data...", "#2ecc71");
             if ('serviceWorker' in navigator && 'SyncManager' in window) {
                 navigator.serviceWorker.ready.then(sw => { return sw.sync.register('sync-attendance'); });
             } else { fetch('/sw.js'); } 
             if(typeof syncOfflineData === 'function') syncOfflineData();
        });

        window.addEventListener('offline', () => {
            showSyncBar("MOD OFFLINE: Data akan disimpan dalam telefon.", "#e74c3c");
        });

        function showSyncBar(msg, color) {
            const bar = document.getElementById('syncStatusBar');
            if(bar) {
                bar.innerText = msg;
                bar.style.background = color;
                bar.style.display = 'block';
                if(color === "#2ecc71") setTimeout(() => { bar.style.display = 'none'; }, 4000);
            }
        }

        function syncOfflineData() {
            if (!navigator.onLine) return;
            let offlineQueue = JSON.parse(localStorage.getItem('ehadir_offline_queue') || "[]");
            if (offlineQueue.length === 0) return;

            showSyncBar("Menghantar " + offlineQueue.length + " data tertangguh...", "#3498db");
            
            let itemToSync = offlineQueue[0];
            
            // Re-use sendData but force online check bypass
            fetch(API_URL, { method: "POST", body: JSON.stringify(itemToSync) })
            .then(r => r.json())
            .then(d => {
                if(d.result === "success") {
                    offlineQueue.shift();
                    localStorage.setItem('ehadir_offline_queue', JSON.stringify(offlineQueue));
                    syncOfflineData(); // Recursion sampai habis
                } else {
                    showSyncBar("Gagal Sync. Cuba lagi nanti.", "#e74c3c");
                }
            })
            .catch(e => { console.log("Sync Error", e); });
        }

        // --- MODERN ALERT SYSTEM ---
        function showModernAlert(title, msg, type, callback = null) {
            let modal = document.getElementById('customModal');
            let mTitle = document.getElementById('modalTitle');
            let mMsg = document.getElementById('modalMsg');
            let mBtns = document.getElementById('modalBtns');
            let mIcon = document.getElementById('modalIcon');

            mTitle.innerText = title;
            mMsg.innerHTML = msg; 
            
            if(type === 'success') { mIcon.innerText = ""; mTitle.style.color = "#27ae60"; }
            else if(type === 'error') { mIcon.innerText = ""; mTitle.style.color = "#c0392b"; }
            else if(type === 'info') { mIcon.innerText = ""; mTitle.style.color = "#2980b9"; }
            else if(type === 'confirm') { mIcon.innerText = ""; mTitle.style.color = "#f39c12"; }

            if (type === 'confirm') {
                 window.tempCallback = callback;
                 mBtns.innerHTML = `<button class="modal-btn btn-cancel-modal" onclick="closeCustomModal()">Batal</button><button class="modal-btn btn-ok" onclick="confirmAction()">Teruskan</button>`;
            } else {
                 mIcon.innerText = "";
                 mTitle.style.color = "#2c3e50";
                 mBtns.innerHTML = `<button class="modal-btn btn-ok" onclick="closeCustomModal()">Tutup</button>`;
            }

            modal.style.display = "flex";
        }

        function closeCustomModal() { document.getElementById('customModal').style.display = "none"; }
        function confirmAction() { closeCustomModal(); if(window.tempCallback) window.tempCallback(); }

        function sendNotification(title, body, tag) {
            if(Notification.permission === "granted") {
                 if('serviceWorker' in navigator) {
                     navigator.serviceWorker.ready.then(reg => {
                         reg.showNotification(title, {
                             body: body,
                             icon: "https://cdn-icons-png.flaticon.com/128/9402/9402342.png",
                             tag: tag,
                             renotify: true,
                             vibrate: [200, 100, 200],
                             data: { url: location.href }
                         });
                     });
                 } else {
                     new Notification(title, { body: body, tag: tag });
                 }
            }
        }

        window.onload = function() {
            startClock();
            startRadar();
            fetchConfig();
            getHijriDate();
            initLockName();
            initAvatar();
            initBackgroundService();

            if(!navigator.onLine) showSyncBar("MOD OFFLINE: Data akan disimpan dalam telefon.", "#e74c3c");
            else syncOfflineData();
            
            setTimeout(() => {
                checkSession();
                setInterval(updateDashboardInfo, 5000);
            }, 2000);
            
            loadList(); // Akan trigger checkAutoStatus di dalamnya
            
            setInterval(updateLiveTimers, 1000);

            const workerBlob = new Blob(["self.onmessage = function() { setInterval(function(){ self.postMessage('tick'); }, 1000); }"], { type: "text/javascript" });
            const worker = new Worker(URL.createObjectURL(workerBlob));
            worker.onmessage = function(e) { monitorAutoLogic(); };
            worker.postMessage("start");
        };

        // --- AVATAR LOGIC (10 OFFICE THEMED) ---
        const AVATARS = [
            "https://cdn-icons-png.flaticon.com/128/4140/4140048.png",
            "https://cdn-icons-png.flaticon.com/128/4140/4140037.png",
            "https://cdn-icons-png.flaticon.com/128/4140/4140047.png",
            "https://cdn-icons-png.flaticon.com/128/4140/4140051.png",
            "https://cdn-icons-png.flaticon.com/128/1999/1999625.png",
            "https://cdn-icons-png.flaticon.com/128/4140/4140061.png",
            "https://cdn-icons-png.flaticon.com/128/4140/4140052.png",
            "https://cdn-icons-png.flaticon.com/128/4140/4140077.png",
            "https://cdn-icons-png.flaticon.com/128/3135/3135715.png",
            "https://cdn-icons-png.flaticon.com/128/3135/3135768.png"
        ];
        let selectedAvatarTemp = "";

        function initAvatar() {
            let saved = localStorage.getItem('ehadir_user_avatar');
            if(saved) document.getElementById('avatarIconBtn').src = saved;
        }

        function openAvatarModal() {
            let grid = document.getElementById('avatarGrid');
            grid.innerHTML = "";
            AVATARS.forEach(url => {
                let div = document.createElement('div');
                div.className = "avatar-option";
                div.innerHTML = `<img src="${url}">`;
                div.onclick = function() {
                     document.querySelectorAll('.avatar-option').forEach(d => d.classList.remove('selected'));
                     div.classList.add('selected');
                     selectedAvatarTemp = url;
                };
                grid.appendChild(div);
            });
            document.getElementById('avatarModalContainer').style.display = 'flex';
        }

        function closeAvatarModal() { document.getElementById('avatarModalContainer').style.display = 'none'; }
        
        function selectAvatar() {
            if(selectedAvatarTemp) {
                localStorage.setItem('ehadir_user_avatar', selectedAvatarTemp);
                document.getElementById('avatarIconBtn').src = selectedAvatarTemp;
                closeAvatarModal();
            }
        }

        // --- LOCK NAME LOGIC ---
        function initLockName() {
            let locked = localStorage.getItem('ehadir_locked_name');
            let lockedKat = localStorage.getItem('ehadir_locked_kat');
            let input = document.getElementById('nama');
            let sel = document.getElementById('kategori');
            let btnLock = document.getElementById('lockNameBtn');
            let btnImg = document.getElementById('lockIconImg');
            let avatarBtn = document.getElementById('avatarBtn');
            let btnPelawatLocked = document.querySelector('.btn-pelawat'); // Get pelawat button

            if (locked && lockedKat) {
                input.value = locked;
                sel.value = lockedKat;
                input.readOnly = true;
                sel.disabled = true;
                avatarBtn.disabled = true; 
                input.style.background = "#fff8e1";
                sel.style.background = "#fff8e1";
                
                // ICON KUNCI: LOCKED (Filled/Yellow)
                btnImg.src = "https://cdn-icons-png.flaticon.com/128/3064/3064155.png";
                btnImg.style.filter = "none";
                btnLock.classList.add('btn-yellow');

                // LOGIK BARU: Tunjuk butang pelawat bila locked
                if(btnPelawatLocked) btnPelawatLocked.style.display = 'flex';
            } else {
                input.readOnly = false;
                sel.disabled = false;
                avatarBtn.disabled = false; 
                input.style.background = "#f8f9fa"; // Warna asal
                sel.style.background = "#f8f9fa";
                
                // ICON KUNCI: UNLOCKED (Line/Round)
                btnImg.src = "https://cdn-icons-png.flaticon.com/128/3064/3064197.png";
                btnImg.style.filter = "opacity(0.6)";
                btnLock.classList.remove('btn-yellow');

                // LOGIK BARU: Sembunyi butang pelawat bila unlocked
                if(btnPelawatLocked) btnPelawatLocked.style.display = 'none';
            }
        }

        function toggleLockName() {
            let input = document.getElementById('nama');
            let sel = document.getElementById('kategori');
            let avatarBtn = document.getElementById('avatarBtn');
            let current = input.value.trim().toUpperCase();
            let currentKat = sel.value;
            let currentAvatar = localStorage.getItem('ehadir_user_avatar');

            // Jika sedang terkunci, buka kunci
            if (input.readOnly) {
                input.readOnly = false;
                sel.disabled = false;
                avatarBtn.disabled = false;
                input.style.background = "#f8f9fa";
                sel.style.background = "#f8f9fa";
                localStorage.removeItem('ehadir_locked_name');
                localStorage.removeItem('ehadir_locked_kat');
                showModernAlert("Nyah-Kunci", "Auto Check-In Dibatalkan.", "info");
                initLockName();
                return;
            }

            // Validasi sebelum kunci
            if(!current) { showModernAlert("Tiada Nama", "Sila isi Nama anda dahulu.", "error"); return; }
            if(!currentKat) { showModernAlert("Tiada Kategori", "Sila pilih Kategori dahulu.", "error"); return; }
            if(!currentAvatar) { showModernAlert("Tiada Avatar", "Sila pilih Avatar anda dahulu.", "error"); return; }

            // Kunci Data
            input.readOnly = true;
            sel.disabled = true;
            avatarBtn.disabled = true;
            input.style.background = "#fff8e1";
            sel.style.background = "#fff8e1";
            localStorage.setItem('ehadir_locked_name', current);
            localStorage.setItem('ehadir_locked_kat', currentKat);
            
            showModernAlert("Dikunci!", "Auto Check-In kini aktif. Data anda disimpan.", "success");
            initLockName();
        }

        function updateScheduleInfo() {
            let div = document.getElementById('scheduleInfo');
            if(!div) return;
            
            let html = `<div class="schedule-minimal pop-in">`;
            for (const [key, val] of Object.entries(JADUAL_BERTUGAS)) {
                 if(key !== "PELAWAT") {
                     html += `<div class="time-pill">
                                <span style="color:#1e3c72;">${key.substring(0,3)}</span>
                                <span style="font-weight:400; color:#555;">${val.masuk.replace(":00 ", "").replace(" AM","")} - ${val.keluar.replace(":00 ", "").replace(" PM","")}</span>
                              </div>`;
                 }
            }
            html += `</div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }

        function startClock() {
            setInterval(() => {
                let now = new Date();
                document.getElementById('clockDisplay').innerText = now.toLocaleTimeString('en-US', {hour12:true, hour:'2-digit', minute:'2-digit', second:'2-digit'});
                document.getElementById('dateDisplay').innerText = now.toLocaleDateString('ms-MY', {weekday:'long', year:'numeric', month:'short', day:'numeric'}).toUpperCase();
            }, 1000);
        }

        function getHijriDate() {
            try {
                let d = new Date();
                let f = new Intl.DateTimeFormat('ms-MY-u-ca-islamic', {day: 'numeric', month: 'long'});
                document.getElementById('hijriDisplay').innerText = f.format(d).toUpperCase();
            } catch(e) { console.log("Hijri Error"); }
        }

        function checkSession() {
            let s = JSON.parse(localStorage.getItem('ehadir_session'));
            let form = document.getElementById('defaultForm');
            let dash = document.getElementById('dashboardPanel');
            let wBox = document.getElementById('warningBox');

            if (s && s.nama) {
                form.style.display = 'none';
                dash.style.display = 'block';
                if(wBox) wBox.style.display = 'none'; // Hide warning initially
                document.getElementById('sessionName').innerText = s.nama;
                document.getElementById('dynamicStatus').innerText = "STATUS: " + s.kategori + " (SEDANG BERTUGAS)";
                
                // FIX: GUNA AVATAR DALAM SESSION JIKA ADA
                let savedAvatar = s.avatar || localStorage.getItem('ehadir_user_avatar');
                if(savedAvatar) document.getElementById('userAvatarDash').src = savedAvatar;
                
                updateDashboardInfo();
            } else {
                form.style.display = 'block';
                dash.style.display = 'none';
            }
        }

        function updateDashboardInfo() {
            let s = JSON.parse(localStorage.getItem('ehadir_session'));
            if(s && JADUAL_BERTUGAS[s.kategori]) {
                let exitTime = JADUAL_BERTUGAS[s.kategori].keluar;
                document.getElementById('userExitTime').innerText = exitTime;
                document.getElementById('dashboardSchedule').style.display = "block";
            }
        }

        // --- HELPER UNTUK KIRA MASA (LIVE TIMER) ---
        function parseTimeToday(timeStr) {
            if(!timeStr || timeStr === "BEBAS") return null;
            let d = new Date();
            let parts = timeStr.match(/(\d+):(\d+)(?::(\d+))?\s*(AM|PM)/i);
            if(parts) {
                let h = parseInt(parts[1]);
                let m = parseInt(parts[2]);
                let ampm = parts[4].toUpperCase();
                if(ampm === "PM" && h < 12) h += 12;
                if(ampm === "AM" && h === 12) h = 0;
                d.setHours(h, m, 0, 0);
                return d;
            }
            let p2 = tStr.match(/(\d+)[:.](\d+)/);
            if(p2) {
                d.setHours(parseInt(p2[1]), parseInt(p2[2]), 0, 0);
                return d;
            }
            return null;
        }

        function parseTimeLocal(timeStr) {
            if (!timeStr) return null;
            if (timeStr.toString().length > 15) {
                let tempD = new Date(timeStr);
                if(!isNaN(tempD.getTime())) {
                    let now = new Date();
                    now.setHours(tempD.getHours(), tempD.getMinutes(), tempD.getSeconds(), 0);
                    return now;
                }
            }
            let parts = timeStr.match(/(\d+):(\d+)(?::(\d+))?\s*(AM|PM|am|pm)?/i);
            if (!parts) return null;
            let h = parseInt(parts[1]), m = parseInt(parts[2]), s = parts[3] ? parseInt(parts[3]) : 0, ampm = parts[4] ? parts[4].toUpperCase() : null;
            if (ampm === "PM" && h < 12) h += 12;
            if (ampm === "AM" && h === 12) h = 0;
            let d = new Date();
            d.setHours(h, m, s, 0);
            return d;
        }

        function updateLiveTimers() {
            let now = new Date();
            document.querySelectorAll('.live-timer').forEach(el => {
                let masukStr = el.getAttribute('data-masuk');
                if (!masukStr || masukStr === "undefined") {
                    el.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/128/2972/2972531.png" style="width:12px;height:12px;vertical-align:middle"> --`;
                    return;
                }
                let masukDate = parseTimeLocal(masukStr);
                if (masukDate) {
                    let diff = Math.floor((now - masukDate) / 1000);
                    if (diff < 60) el.innerText = `${diff}s`;
                    else if (diff < 3600) el.innerText = `${Math.floor(diff/60)}m`;
                    else el.innerText = `${Math.floor(diff/3600)}j ${Math.floor((diff%3600)/60)}m`;
                    el.style.color = "#27ae60";
                    el.style.fontWeight = "bold";
                }
            });
        }

        function renderList(list) {
            let container = document.getElementById('listContainer');
            let countEl = document.getElementById('count');
            
            // Filter hanya MASUK (Untuk paparan utama)
            // Namun list server biasanya raw, jadi kita filter yg relevant
            // Sort: Terbaru di atas
            let today = new Date().toISOString().slice(0,10);
            
            // Susun ikut masa terkini (clientTime desc)
            list.sort((a,b) => new Date(b.clientTime || b.timestamp) - new Date(a.clientTime || a.timestamp));

            container.innerHTML = "";
            let count = 0;
            
            if(list.length === 0) {
                container.innerHTML = "<div style='padding:20px; color:#999; font-size:12px;'>Tiada rekod hari ini.</div>";
                countEl.innerText = 0;
                return;
            }

            list.forEach((item, index) => {
                // Determine Avatar
                let avatarUrl = item.avatar || "https://cdn-icons-png.flaticon.com/128/3135/3135715.png";
                if(item.kategori === "PELAWAT" && item.foto) avatarUrl = item.foto; // Guna foto sebenar jika pelawat

                // Badge Status
                let isOut = (item.keluar && item.keluar !== "");
                let badge = isOut 
                    ? `<span class="time-badge time-out"><img src="https://cdn-icons-png.flaticon.com/128/1828/1828843.png" style="width:10px;margin-right:3px;">KELUAR: ${item.keluar}</span>` 
                    : `<span class="time-badge"><img src="https://cdn-icons-png.flaticon.com/128/1828/1828919.png" style="width:10px;margin-right:3px;">MASUK: ${item.jam}</span>`;
                
                let duration = "";
                if(!isOut && item.jam) {
                     duration = `<span class="live-timer" data-masuk="${item.jam}" style="font-size:10px; margin-left:5px; color:#7f8c8d;">...</span>`;
                }

                // Pelawat Image Click
                let imgAction = "";
                if(item.kategori === "PELAWAT" && item.foto) {
                    imgAction = `onclick="viewImage(${index})" style="cursor:pointer"`;
                }

                // Check offline flag
                let offlineTag = item.isOffline ? `<span class="offline-badge">SYNC PENDING</span>` : "";

                let row = `
                    <div class="list-item">
                        <div class="user-info-row">
                            <img src="${avatarUrl}" class="user-avatar-small" ${imgAction}>
                            <div class="user-details">
                                <span class="user-name">${item.nama} ${offlineTag}</span>
                                <span class="user-cat">${item.kategori} &bull; ${item.alasan || ''}</span>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            ${badge}
                            ${duration}
                            ${(isOut) ? "" : `<span class="jam-keluar-display">Pulang: ${JADUAL_BERTUGAS[item.kategori] ? JADUAL_BERTUGAS[item.kategori].keluar : '-'}</span>`}
                        </div>
                    </div>
                    `;
                container.innerHTML += row;
                count++;
            });
            
            countEl.innerText = count;
            
            // Global List Reference for modal
            window.currentList = list;
            
            // Check Auto Logic immediately after list render
            // checkAutoStatus(list); -- SUDAH DIPANGGIL DALAM LOADLIST
            updateLiveTimers();
        }

        function viewImage(index) { let data = currentList[index]; if(data && data.foto) { document.getElementById('imgFull').src = data.foto; document.getElementById('imageModal').style.display = "flex"; } }
        function closeModal() { document.getElementById('imageModal').style.display = "none"; }
        function processImage(i){if(i.files&&i.files[0]){let r=new FileReader();r.onload=function(e){let im=new Image();im.src=e.target.result;im.onload=function(){let cv=document.createElement("canvas");let ctx=cv.getContext("2d");cv.width=400;cv.height=400*(im.height/im.width);ctx.drawImage(im,0,0,cv.width,cv.height);let d=cv.toDataURL("image/jpeg",0.7);document.getElementById('previewImg').src=d;document.getElementById('previewImg').style.display='block';document.getElementById('base64Foto').value=d;};};r.readAsDataURL(i.files[0]);}}
        function checkKategori(){ if(document.getElementById('kategori').value==='PELAWAT') showPelawatForm(); }
        function showPelawatForm(){ document.getElementById('defaultForm').style.display='none'; document.getElementById('pelawatPanel').style.display='block'; }
        
        // FUNGSI UTAMA LOADLIST DENGAN CHECK_AUTO
        function loadList() {
            let offlineQueue = JSON.parse(localStorage.getItem('ehadir_offline_queue') || "[]");
            let offlineItems = offlineQueue.filter(q => q.action === "MASUK").map(q => ({ nama: q.nama, kategori: q.kategori, jam: new Date(q.clientTime).toLocaleTimeString('en-US', {hour12:true, hour:'2-digit', minute:'2-digit', second:'2-digit'}), avatar: q.avatar, isOffline: true }));
            
            if(!navigator.onLine) {
                renderList(offlineItems);
                return;
            }

            fetch(API_URL, { method: "POST", body: JSON.stringify({action: "GET_LIST", passcode: PASSCODE}) })
            .then(r => r.json()).then(res => { 
                let serverItems = res.data || res;
                
                // --- INI FUNGSI PENTING YANG DIMINTA ---
                checkAutoStatus(serverItems); 
                // ---------------------------------------

                currentList = [...offlineItems, ...serverItems];
                
                // Buang duplicate (Offline items mungkin dah ada di server)
                // Logic simple: Jika nama & tarikh sama, ambil server
                // Tapi untuk UI, kita just render dulu.
                
                renderList(currentList);
            })
            .catch(e => {
                console.log("Gagal load list", e);
                renderList(offlineItems); // Fallback tunjuk offline je
            });
        }

    </script>
</body>
</html>
