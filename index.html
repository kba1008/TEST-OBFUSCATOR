<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencetak Sijil Pukal</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3367d6">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            color: #3367d6;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3367d6;
            font-size: 1.5em;
        }

        .upload-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .upload-box {
            flex: 1;
            min-width: 250px;
            padding: 20px;
            border: 3px dashed #3367d6;
            border-radius: 10px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-box:hover {
            background: #eef1ff;
            transform: scale(1.02);
        }

        .upload-box i {
            font-size: 3em;
            color: #3367d6;
            margin-bottom: 10px;
        }

        .upload-box p {
            color: #666;
            font-size: 1.1em;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        #templatePreviewContainer {
            margin-top: 20px;
            text-align: center;
            overflow-x: auto;
        }

        #templatePreview {
            /* Edit: Ensure wrapper fits image exactly for accurate coordinates */
            display: inline-block;
            position: relative;
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            line-height: 0; /* Remove extra space */
        }

        #certificateTemplate {
            max-width: 100%;
            max-height: 500px;
            display: none;
        }

        #headersContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            min-height: 60px;
        }

        .draggable-header {
            padding: 12px 20px;
            background: linear-gradient(135deg, #3367d6 0%, #2c5282 100%);
            color: white;
            border-radius: 8px;
            cursor: move;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .draggable-header:hover {
            transform: translateY(-2px);
        }

        .drop-zone {
            position: absolute;
            min-width: 100px;
            padding: 5px 10px;
            background: rgba(255, 255, 0, 0.4);
            border: 2px dashed #ff6b6b;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            line-height: 1.2;
            user-select: none;
        }

        .drop-zone:hover, .drop-zone.selected-zone {
            background: rgba(255, 255, 0, 0.7);
            border-color: #d97706;
            z-index: 20;
            box-shadow: 0 0 15px rgba(217, 119, 6, 0.5);
        }

        .drop-zone .remove-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
        }

        #styleEditor {
            background: #f0f9ff;
            border: 2px solid #3367d6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .style-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .style-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .style-group label {
            font-size: 0.9em;
            font-weight: bold;
            color: #444;
        }

        .style-input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #previewSection {
            margin-top: 30px;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .certificate-preview {
            /* Auto size based on content/image ratio now */
            width: 100%;
            max-width: 800px;
            position: relative;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            page-break-after: always;
            line-height: 0;
        }
        
        .certificate-preview img.bg-img {
            width: 100%;
            height: auto;
            display: block;
        }

        .preview-field {
            position: absolute;
            line-height: normal;
            white-space: nowrap;
            transform: translate(0, 0); /* Origin point */
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button i {
            font-size: 1.2em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3367d6 0%, #2c5282 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(51, 103, 214, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .hidden {
            display: none !important;
        }

        .status-message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 5px solid #10b981;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 5px solid #ef4444;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 5px solid #3367d6;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .card, header, .upload-section, .btn-group, #styleEditor {
                display: none;
            }
            
            .preview-container {
                display: block;
            }
            
            .certificate-preview {
                width: 100% !important;
                max-width: none !important;
                height: auto !important;
                page-break-after: always;
                border: none;
                box-shadow: none;
            }
            
            .preview-field {
                background: transparent !important;
            }
        }

        @media (max-width: 768px) {
            .upload-section {
                flex-direction: column;
            }
            
            .certificate-preview {
                width: 100%;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñ®Ô∏è Pencetak Sijil Pukal</h1>
            <p class="subtitle">Muat naik template sijil & senarai peserta untuk cetak pukal</p>
            <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8; font-weight: bold;">Versi: V1.0 pro</p>
        </header>

        <div class="card">
            <h2 class="card-title">üìÅ 1. Muat Naik Template Sijil</h2>
            <div class="upload-section">
                <div class="upload-box" id="templateDropZone">
                    <div>üñºÔ∏è</div>
                    <p>Klik atau Drag Template Sijil</p>
                    <p><small>(Format: JPG, PNG, PDF)</small></p>
                    <input type="file" id="templateUpload" accept="image/*,.pdf">
                </div>
            </div>
            <div id="templatePreviewContainer" class="hidden">
                <h3>üì∏ Preview Template:</h3>
                <div id="templatePreview">
                    <img id="certificateTemplate" alt="Template Sijil">
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">üìä 2. Muat Naik Senarai Peserta (Excel)</h2>
            <div class="upload-section">
                <div class="upload-box" id="excelDropZone">
                    <div>üìã</div>
                    <p>Klik atau Drag Fail Excel</p>
                    <p><small>(Format: XLSX, XLS, CSV)</small></p>
                    <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv">
                </div>
            </div>
            
            <div id="excelStatus" class="hidden"></div>
            
            <div id="mappingSection" class="hidden">
                <h3>üéØ 3. Letakkan Field pada Template</h3>
                <p style="margin: 10px 0; color: #666;">
                    <strong>Drag & Drop</strong> header ke atas template. <strong>Klik field</strong> di atas template untuk ubah saiz & warna.
                </p>
                
                <div id="headersContainer"></div>

                <!-- NEW: Style Editor -->
                <div id="styleEditor" class="hidden">
                    <h4 style="margin-bottom: 10px; color: #3367d6;">‚ú® Tetapan Field: <span id="editingFieldName">-</span></h4>
                    <div class="style-controls">
                        <div class="style-group">
                            <label>Saiz Font (px)</label>
                            <input type="number" id="editFontSize" class="style-input" value="20" min="8" max="200">
                        </div>
                        <div class="style-group">
                            <label>Warna Teks</label>
                            <input type="color" id="editColor" class="style-input" value="#000000" style="height: 38px; width: 60px;">
                        </div>
                        <div class="style-group">
                            <label>Jenis Font</label>
                            <select id="editFontFamily" class="style-input">
                                <option value="'Segoe UI', sans-serif">Segoe UI (Default)</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                                <option value="'Arial', sans-serif">Arial</option>
                                <option value="'Courier New', monospace">Courier New</option>
                                <option value="'Georgia', serif">Georgia</option>
                                <option value="'Verdana', sans-serif">Verdana</option>
                                <option value="cursive">Tulisan Tangan (Cursive)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-warning" id="resetMappingBtn">
                        üîÑ Reset Semua Kedudukan
                    </button>
                    <button class="btn-primary" id="generateBtnMain">
                        üé® Jana Preview Sijil
                    </button>
                </div>
            </div>
        </div>

        <div class="card hidden" id="previewCard">
            <h2 class="card-title">üëÄ 4. Preview & Cetak</h2>
            <div class="btn-group">
                <button class="btn-primary" id="generateBtn">üé® Jana Preview Sijil</button>
                <button class="btn-success" id="printBtn">üñ®Ô∏è Cetak Semua Sijil</button>
                <button class="btn-secondary" id="downloadPdfBtn">üì• Download Semua (PDF)</button>
                <button class="btn-danger" id="clearAllBtn">üóëÔ∏è Kosongkan Semua</button>
            </div>
            
            <div id="previewSection">
                <div class="preview-container" id="previewContainer"></div>
            </div>
        </div>
    </div>

    <!-- SheetJS Library untuk baca Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDF untuk export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let templateDataURL = null;
        let excelData = null;
        let headers = [];
        let dropZones = [];
        let certificatesGenerated = false;
        let selectedDropZone = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            registerServiceWorker();
            setupStyleEditorListeners();
        });

        function setupEventListeners() {
            // Template upload
            document.getElementById('templateUpload').addEventListener('change', handleTemplateUpload);
            document.getElementById('templateDropZone').addEventListener('click', () => document.getElementById('templateUpload').click());
            
            // Excel upload
            document.getElementById('excelUpload').addEventListener('change', handleExcelUpload);
            document.getElementById('excelDropZone').addEventListener('click', () => document.getElementById('excelUpload').click());
            
            // Generate certificates
            document.getElementById('generateBtn').addEventListener('click', generateCertificates);
            document.getElementById('generateBtnMain').addEventListener('click', generateCertificates);
            
            // Print
            document.getElementById('printBtn').addEventListener('click', printCertificates);
            
            // Download PDF
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadAsPDF);
            
            // Clear all
            document.getElementById('clearAllBtn').addEventListener('click', clearAll);
            
            // Reset mapping
            document.getElementById('resetMappingBtn').addEventListener('click', resetMapping);
            
            // Drag and drop for template
            setupDragDrop('templateDropZone', handleTemplateUpload);
            setupDragDrop('excelDropZone', handleExcelUpload);
        }

        function setupStyleEditorListeners() {
            const fontSizeInput = document.getElementById('editFontSize');
            const colorInput = document.getElementById('editColor');
            const fontFamilyInput = document.getElementById('editFontFamily');

            const updateStyle = () => {
                if (selectedDropZone) {
                    selectedDropZone.style.fontSize = fontSizeInput.value + 'px';
                    selectedDropZone.style.color = colorInput.value;
                    selectedDropZone.style.fontFamily = fontFamilyInput.value;
                    
                    // Simpan data dalam dataset untuk rujukan nanti
                    selectedDropZone.dataset.fontSize = fontSizeInput.value;
                    selectedDropZone.dataset.color = colorInput.value;
                    selectedDropZone.dataset.fontFamily = fontFamilyInput.value;
                }
            };

            fontSizeInput.addEventListener('input', updateStyle);
            colorInput.addEventListener('input', updateStyle);
            fontFamilyInput.addEventListener('change', updateStyle);
        }

        // ============================================
        // TEMPLATE HANDLING
        // ============================================
        function handleTemplateUpload(event) {
            const file = event.target.files?.[0] || event.dataTransfer?.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                templateDataURL = e.target.result;
                const img = document.getElementById('certificateTemplate');
                img.src = templateDataURL;
                img.style.display = 'block';
                
                document.getElementById('templatePreviewContainer').classList.remove('hidden');
                
                showStatus('Template berjaya dimuat naik!', 'success');
                
                // Reset drop zones if template changes
                resetMapping();
            };
            reader.readAsDataURL(file);
        }

        // ============================================
        // EXCEL HANDLING
        // ============================================
        function handleExcelUpload(event) {
            const file = event.target.files?.[0] || event.dataTransfer?.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if (jsonData.length === 0) {
                        showStatus('Fail Excel kosong!', 'error');
                        return;
                    }
                    
                    headers = jsonData[0]; // First row is headers
                    excelData = jsonData.slice(1); // Rest is data
                    
                    document.getElementById('excelStatus').innerHTML = `
                        <div class="status-success">
                            ‚úÖ Berjaya muat naik: ${excelData.length} rekod dengan ${headers.length} medan
                        </div>
                    `;
                    document.getElementById('excelStatus').classList.remove('hidden');
                    
                    displayHeadersForMapping();
                    document.getElementById('mappingSection').classList.remove('hidden');
                    
                    showStatus(`Berjaya baca ${excelData.length} rekod dari Excel!`, 'success');
                    
                } catch (error) {
                    console.error('Error reading Excel:', error);
                    showStatus('Ralat membaca fail Excel: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayHeadersForMapping() {
            const container = document.getElementById('headersContainer');
            container.innerHTML = '';
            
            headers.forEach((header, index) => {
                const headerElement = document.createElement('div');
                headerElement.className = 'draggable-header';
                headerElement.draggable = true;
                headerElement.dataset.headerIndex = index;
                headerElement.textContent = header;
                
                // Drag start
                headerElement.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', index);
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                container.appendChild(headerElement);
            });
            
            // Setup drop zones on template preview
            const templatePreview = document.getElementById('templatePreview');
            templatePreview.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            templatePreview.addEventListener('drop', function(e) {
                e.preventDefault();
                
                const headerIndex = e.dataTransfer.getData('text/plain');
                if (headerIndex === '') return;
                
                // Calculate position relative to template preview
                const rect = templatePreview.getBoundingClientRect();
                // We need to account for scroll positions if any
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                createDropZone(parseInt(headerIndex), x, y);
            });
        }

        // ============================================
        // DROP ZONE HANDLING (UPDATED)
        // ============================================
        function createDropZone(headerIndex, x, y) {
            const templatePreview = document.getElementById('templatePreview');
            
            // Create drop zone
            const dropZone = document.createElement('div');
            dropZone.className = 'drop-zone';
            dropZone.dataset.headerIndex = headerIndex;
            dropZone.style.left = x + 'px';
            dropZone.style.top = y + 'px';
            dropZone.textContent = headers[headerIndex];
            
            // Default Styles
            dropZone.style.fontSize = '20px';
            dropZone.style.color = '#000000';
            dropZone.style.fontFamily = "'Segoe UI', sans-serif";
            // Store defaults in dataset
            dropZone.dataset.fontSize = '20';
            dropZone.dataset.color = '#000000';
            dropZone.dataset.fontFamily = "'Segoe UI', sans-serif";

            // SELECT FUNCTION (Show Editor)
            dropZone.addEventListener('click', function(e) {
                e.stopPropagation();
                selectZone(dropZone);
            });

            // DRAGGABLE LOGIC
            dropZone.addEventListener('mousedown', function(e) {
                if (e.target.className === 'remove-btn') return;
                
                // Select automatically on drag start
                selectZone(dropZone);
                
                const offsetX = e.clientX - dropZone.getBoundingClientRect().left;
                const offsetY = e.clientY - dropZone.getBoundingClientRect().top;
                
                function onMouseMove(e) {
                    const rect = templatePreview.getBoundingClientRect();
                    let newX = e.clientX - rect.left - offsetX;
                    let newY = e.clientY - rect.top - offsetY;
                    
                    // Keep within bounds
                    newX = Math.max(0, Math.min(newX, rect.width - dropZone.offsetWidth));
                    newY = Math.max(0, Math.min(newY, rect.height - dropZone.offsetHeight));
                    
                    dropZone.style.left = newX + 'px';
                    dropZone.style.top = newY + 'px';
                }
                
                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            
            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '√ó';
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (selectedDropZone === dropZone) {
                     document.getElementById('styleEditor').classList.add('hidden');
                     selectedDropZone = null;
                }
                dropZone.remove();
            });
            dropZone.appendChild(removeBtn);
            
            templatePreview.appendChild(dropZone);
            dropZones.push(dropZone);
            
            // Select newly created zone
            selectZone(dropZone);
        }

        function selectZone(zone) {
            // Remove active class from old zone
            if (selectedDropZone) selectedDropZone.classList.remove('selected-zone');
            
            selectedDropZone = zone;
            selectedDropZone.classList.add('selected-zone');
            
            // Show editor
            const editor = document.getElementById('styleEditor');
            editor.classList.remove('hidden');
            
            // Update Editor Values from Zone
            document.getElementById('editingFieldName').textContent = headers[zone.dataset.headerIndex];
            document.getElementById('editFontSize').value = zone.dataset.fontSize || 20;
            document.getElementById('editColor').value = zone.dataset.color || '#000000';
            document.getElementById('editFontFamily').value = zone.dataset.fontFamily || "'Segoe UI', sans-serif";
        }

        function resetMapping() {
            const templatePreview = document.getElementById('templatePreview');
            const dropZones = templatePreview.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => zone.remove());
            
            selectedDropZone = null;
            document.getElementById('styleEditor').classList.add('hidden');
            showStatus('Semua kedudukan telah direset', 'info');
        }

        // ============================================
        // CERTIFICATE GENERATION (UPDATED Logic)
        // ============================================
        function generateCertificates() {
            if (!templateDataURL) {
                showStatus('Sila muat naik template sijil dahulu!', 'error');
                return;
            }
            
            if (!excelData || excelData.length === 0) {
                showStatus('Sila muat naik fail Excel dahulu!', 'error');
                return;
            }
            
            const templatePreview = document.getElementById('templatePreview');
            const dropZones = templatePreview.querySelectorAll('.drop-zone');
            const templateImg = document.getElementById('certificateTemplate');
            
            if (dropZones.length === 0) {
                showStatus('Sila letakkan field pada template dahulu!', 'error');
                return;
            }
            
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';
            
            // Get Mapping Dimensions (Original reference)
            const mapWidth = templatePreview.offsetWidth;
            const mapHeight = templatePreview.offsetHeight;
            
            // Map field positions as PERCENTAGES to avoid position jumping
            const fieldConfigs = Array.from(dropZones).map(zone => {
                return {
                    headerIndex: parseInt(zone.dataset.headerIndex),
                    leftPct: (zone.offsetLeft / mapWidth) * 100,
                    topPct: (zone.offsetTop / mapHeight) * 100,
                    fontSize: parseInt(zone.dataset.fontSize),
                    color: zone.dataset.color,
                    fontFamily: zone.dataset.fontFamily
                };
            });
            
            // Generate certificate for each row
            excelData.forEach((row, rowIndex) => {
                const certificate = document.createElement('div');
                certificate.className = 'certificate-preview';
                
                // Use IMG tag for background to ensure perfect scaling ratio
                const bgImg = document.createElement('img');
                bgImg.src = templateDataURL;
                bgImg.className = 'bg-img';
                certificate.appendChild(bgImg);
                
                // Add fields
                fieldConfigs.forEach(config => {
                    const field = document.createElement('div');
                    field.className = 'preview-field';
                    
                    // Apply Percentage Positions
                    field.style.left = config.leftPct + '%';
                    field.style.top = config.topPct + '%';
                    
                    // Apply Styles
                    // Scale font size based on preview width vs map width approx ratio
                    // But since we use same CSS px, we need a scale factor if sizes differ wildly
                    // For simplicity in HTML preview, we trust px relative to the image size if responsive
                    // To be safe, we let standard CSS scale handle position, but Font Size is fixed in px.
                    // If the preview is larger than mapping area, font looks smaller. 
                    // Let's rely on standard px unless user adjusts.
                    field.style.fontSize = config.fontSize + 'px';
                    field.style.color = config.color;
                    field.style.fontFamily = config.fontFamily;
                    field.style.fontWeight = 'bold';
                    
                    field.textContent = row[config.headerIndex] || '';
                    
                    certificate.appendChild(field);
                });
                
                previewContainer.appendChild(certificate);
            });
            
            document.getElementById('previewCard').classList.remove('hidden');
            certificatesGenerated = true;
            
            showStatus(`Berjaya jana ${excelData.length} sijil!`, 'success');
        }

        // ============================================
        // PRINT & EXPORT
        // ============================================
        function printCertificates() {
            if (!certificatesGenerated) {
                showStatus('Sila jana preview sijil dahulu!', 'error');
                return;
            }
            window.print();
        }

        async function downloadAsPDF() {
            if (!certificatesGenerated) {
                showStatus('Sila jana preview sijil dahulu!', 'error');
                return;
            }
            
            showStatus('‚è≥ Sedang menjana PDF...', 'info');
            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                const { jsPDF } = window.jspdf;
                const templateImg = document.getElementById('certificateTemplate');
                const dropZones = document.querySelectorAll('.drop-zone');
                
                // 1. Get original image dimensions
                const imgWidth = templateImg.naturalWidth;
                const imgHeight = templateImg.naturalHeight;
                const orientation = imgWidth > imgHeight ? 'l' : 'p';
                
                // 2. Mapping Dimensions
                const mapRect = document.getElementById('templatePreview').getBoundingClientRect();
                
                const doc = new jsPDF({ 
                    orientation: orientation,
                    unit: 'px',
                    format: [imgWidth, imgHeight]
                });

                // 3. Map Fields with Scaled Coordinates
                const fields = Array.from(dropZones).map(zone => {
                    // Calculate relative position in Percentage
                    const leftPct = zone.offsetLeft / mapRect.width;
                    const topPct = zone.offsetTop / mapRect.height;
                    
                    // Calculate Scale Factor for Font
                    // Ratio: PDF Width / Mapping Width
                    const scaleFactor = imgWidth / mapRect.width;
                    
                    return {
                        headerIndex: parseInt(zone.dataset.headerIndex),
                        x: leftPct * imgWidth,
                        y: topPct * imgHeight,
                        fontSize: parseInt(zone.dataset.fontSize) * scaleFactor,
                        color: zone.dataset.color,
                        fontFamily: zone.dataset.fontFamily
                    };
                });

                // 4. Generate Pages
                excelData.forEach((row, i) => {
                    if (i > 0) doc.addPage([imgWidth, imgHeight], orientation);
                    
                    doc.addImage(templateDataURL, 'JPEG', 0, 0, imgWidth, imgHeight);
                    
                    fields.forEach(field => {
                        const text = String(row[field.headerIndex] || '');
                        
                        // Convert Hex Color to RGB
                        const hex = field.color;
                        const r = parseInt(hex.slice(1, 3), 16);
                        const g = parseInt(hex.slice(3, 5), 16);
                        const b = parseInt(hex.slice(5, 7), 16);
                        
                        doc.setFontSize(field.fontSize);
                        doc.setTextColor(r, g, b);
                        
                        // Font mapping (Simple)
                        if (field.fontFamily.includes('Times')) doc.setFont("times", "bold");
                        else if (field.fontFamily.includes('Courier')) doc.setFont("courier", "bold");
                        else doc.setFont("helvetica", "bold");
                        
                        // Add text (Offset Y slightly because PDF text origin is bottom-left of text usually, but jsPDF varies)
                        // For jsPDF, x,y is usually baseline or top-left depending on baseline setting. Default is baseline.
                        // UI drag is Top-Left. We add fontSize to Y to approximate baseline.
                        doc.text(text, field.x, field.y + (field.fontSize * 0.8));
                    });
                });

                doc.save('Sijil-Pukal.pdf');
                showStatus('‚úÖ PDF berjaya dimuat turun!', 'success');
                
            } catch (err) {
                console.error(err);
                showStatus('Ralat menjana PDF: ' + err.message, 'error');
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function clearAll() {
            document.getElementById('templateUpload').value = '';
            document.getElementById('excelUpload').value = '';
            
            document.getElementById('certificateTemplate').src = '';
            document.getElementById('certificateTemplate').style.display = 'none';
            document.getElementById('templatePreviewContainer').classList.add('hidden');
            document.getElementById('excelStatus').classList.add('hidden');
            document.getElementById('excelStatus').innerHTML = '';
            document.getElementById('mappingSection').classList.add('hidden');
            document.getElementById('headersContainer').innerHTML = '';
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('previewCard').classList.add('hidden');
            document.getElementById('styleEditor').classList.add('hidden');
            
            templateDataURL = null;
            excelData = null;
            headers = [];
            dropZones = [];
            certificatesGenerated = false;
            selectedDropZone = null;
            
            resetMapping();
            showStatus('Semua telah dikosongkan!', 'info');
        }

        function showStatus(message, type) {
            let statusDiv = document.getElementById('globalStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'globalStatus';
                statusDiv.style.position = 'fixed';
                statusDiv.style.top = '20px';
                statusDiv.style.right = '20px';
                statusDiv.style.zIndex = '1000';
                document.body.appendChild(statusDiv);
            }
            
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function setupDragDrop(elementId, callback) {
            const element = document.getElementById(elementId);
            
            element.addEventListener('dragover', function(e) {
                e.preventDefault();
                element.style.borderColor = '#10b981';
                element.style.backgroundColor = '#f0fdf4';
            });
            
            element.addEventListener('dragleave', function() {
                element.style.borderColor = '#3367d6';
                element.style.backgroundColor = '';
            });
            
            element.addEventListener('drop', function(e) {
                e.preventDefault();
                element.style.borderColor = '#3367d6';
                element.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length > 0) {
                    const event = { dataTransfer: e.dataTransfer };
                    callback(event);
                }
            });
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            }
        }
    </script>
</body>
</html>
