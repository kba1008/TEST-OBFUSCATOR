<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pelawat & Kehadiran v23.0 (Manual Override Fix)</title>
    
    <script>
        // 1. Masukkan Link Google Apps Script (Web App URL) di sini
        const API_URL = 'https://script.google.com/macros/s/AKfycby7EZT41FWLpDMh27qGfpfJYZEnJPs2mMqN0lS8UYSVogiofK0Xu8tG3ucX2FDybABI/exec'; 
        
        // 2. Kata Laluan untuk Admin / Manual Override
        const PASSCODE = "101010";
           
        // 3. Koordinat Lokasi (Ambil dari Google Maps)
        const SCHOOL_LAT = 5.227691965160906; 
        const SCHOOL_LNG = 100.69903377890643; 
        
        // 4. Jarak Radius yang dibenarkan (dalam meter)
        const RADIUS_METER = 50; 

        // 5. Nama Sekolah (Untuk Tajuk)
        const SCHOOL_NAME = "SK SELAMA (PERAK)";
    </script>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: sans-serif; background: #f4f6f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { background: white; width: 100%; max-width: 400px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px; }
        .logo { width: 80px; margin-bottom: 10px; }
        h2 { margin: 10px 0; color: #333; font-size: 18px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: #1e3c72; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #2a5298; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-red { background: #e74c3c; }
        .btn-red:hover { background: #c0392b; }
        .hidden { display: none; }
        .status-box { padding: 10px; margin-top: 10px; border-radius: 8px; font-size: 14px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        
        /* List Kehadiran */
        .list-container { margin-top: 20px; width: 100%; max-width: 400px; background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 500px; overflow-y: auto; }
        .list-item { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
        .list-item:last-child { border-bottom: none; }
        .list-info { text-align: left; }
        .list-name { font-weight: bold; font-size: 14px; color: #333; }
        .list-time { font-size: 12px; color: #666; }
        .list-cat { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555; margin-left: 5px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; margin-right: 10px; background: #eee; }
        .refresh-btn { background: none; border: 1px solid #1e3c72; color: #1e3c72; padding: 5px 10px; font-size: 12px; margin-bottom: 10px; border-radius: 20px; width: auto; }

        /* Timer Live */
        .live-timer { font-size: 12px; color: #e67e22; font-weight: bold; margin-top: 2px; }

        /* Modal Image */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { max-width: 90%; max-height: 90%; border-radius: 10px; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }

        /* Pelawat Form */
        #pelawatPanel { display: none; text-align: left; }
        #pelawatPanel label { font-size: 14px; font-weight: bold; color: #555; display: block; margin-top: 10px; }

        /* Loader */
        #loader { display: none; margin: 10px auto; border: 4px solid #f3f3f3; border-top: 4px solid #1e3c72; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Admin Panel */
        #adminPanel { display: none; margin-top: 20px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .manual-note { font-size: 12px; color: #d35400; margin-bottom: 10px; font-style: italic; }
    </style>
</head>
<body>

    <img src="logo.png" alt="Logo" class="logo" onerror="this.src='https://via.placeholder.com/80?text=LOGO'">
    <h2 id="pageTitle">SISTEM KEHADIRAN</h2>
    <div style="font-size:12px; color:#666; margin-bottom:15px;" id="dateDisplay">Loading tarikh...</div>

    <div class="container">
        
        <button id="btnKeluar" class="btn-red hidden" onclick="prosesDaftarKeluar()">DAFTAR KELUAR</button>

        <div id="defaultForm">
            <select id="kategori" onchange="checkKategori()">
                <option value="">-- Pilih Kategori --</option>
                <option value="GURU">GURU</option>
                <option value="AKP">AKP</option>
                <option value="KEBERSIHAN">PEKERJA KEBERSIHAN</option>
                <option value="PELAWAT">PELAWAT / IBU BAPA</option>
            </select>

            <div id="formInputs">
                <input type="text" id="nama" placeholder="Nama Penuh (Huruf Besar)" oninput="this.value = this.value.toUpperCase()">
                
                <div id="pelawatPanel">
                    <label>No. Kad Pengenalan:</label>
                    <input type="text" id="icPelawat" placeholder="Contoh: 801212015566">
                    <label>Tujuan Lawatan:</label>
                    <input type="text" id="tujuan" placeholder="Urusan Pejabat / Jumpa Anak">
                    <label>No. Telefon:</label>
                    <input type="text" id="noTel" placeholder="0123456789">
                </div>

                <div id="adminPanel">
                    <div class="manual-note">Mod Manual: GPS diabaikan. Sila masukkan Passcode.</div>
                    <input type="password" id="passcode" placeholder="Passcode Admin">
                    <select id="statusManual">
                        <option value="HADIR">HADIR</option>
                        <option value="LEWAT">LEWAT</option>
                        <option value="MESYUARAT">MESYUARAT DI LUAR</option>
                        <option value="CRK">CUTI REHAT KHAS (CRK)</option>
                        <option value="MC">CUTI SAKIT (MC)</option>
                    </select>
                </div>

                <div style="margin-top:10px;">
                    <label for="fotoInput" style="font-size:12px; color:#1e3c72; cursor:pointer; display:block; margin-bottom:5px;">ðŸ“· Ambil Gambar (Wajib)</label>
                    <input type="file" id="fotoInput" accept="image/*" capture="user" style="display:none;" onchange="processImage(this)">
                    <button onclick="document.getElementById('fotoInput').click()" style="background:#ddd; color:#333; font-size:12px; padding:5px;">Buka Kamera</button>
                    <img id="previewImg" style="width:100px; height:100px; object-fit:cover; margin:10px auto; display:none; border-radius:10px; border:2px solid #ccc;">
                    <input type="hidden" id="base64Foto">
                </div>

                <div id="loader"></div>
                <div id="msgBox" class="status-box"></div>

                <button onclick="getLocationAndSubmit()" style="margin-top:15px;">DAFTAR MASUK</button>
                <div style="margin-top:10px; font-size:11px; color:#888; cursor:pointer; text-decoration:underline;" onclick="toggleAdmin()">Masalah GPS? Guna Mod Manual</div>
            </div>
        </div>
    </div>

    <div class="list-container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:16px;">Senarai Hadir Hari Ini</h3>
            <button class="refresh-btn" onclick="loadList()">â†» Refresh</button>
        </div>
        <div id="listArea" style="margin-top:10px;">
            Loading senarai...
        </div>
    </div>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="imgFull">
    </div>

    <script>
        document.getElementById('pageTitle').innerText = SCHOOL_NAME;
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('ms-MY', options);

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('Service Worker Registered'))
            .catch(err => console.log('SW Fail:', err));
        }

        let currentList = [];

        // ======================================================================
        //                  FUNGSI UTAMA: DAFTAR MASUK
        // ======================================================================
        function getLocationAndSubmit() {
            let pass = document.getElementById('passcode').value;
            // Jika ada passcode, skip GPS (Mode Manual)
            if (pass.length > 0) {
                if (pass !== PASSCODE) { alert("Passcode Salah!"); return; }
                submitForm(0, 0, true); // Manual
            } else {
                // Mode Biasa (GPS)
                if (navigator.geolocation) {
                    loading(true);
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            let dist = getDistance(SCHOOL_LAT, SCHOOL_LNG, pos.coords.latitude, pos.coords.longitude);
                            if (dist <= RADIUS_METER) {
                                submitForm(pos.coords.latitude, pos.coords.longitude, false);
                            } else {
                                loading(false);
                                alert(`Anda berada di luar kawasan sekolah (${Math.round(dist)}m). Sila masuk ke kawasan sekolah.`);
                            }
                        },
                        (err) => {
                            loading(false);
                            alert("Gagal dapatkan lokasi. Sila pastikan GPS on atau guna Mod Manual.");
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    alert("Browser anda tidak menyokong Geolocation.");
                }
            }
        }

        function submitForm(lat, lng, isManual) {
            let kat = document.getElementById('kategori').value;
            let nama = document.getElementById('nama').value.trim().toUpperCase();
            let foto = document.getElementById('base64Foto').value;
            
            // Validasi
            if(!kat || !nama) { alert("Sila isi Kategori dan Nama."); loading(false); return; }
            if(!foto) { alert("Sila ambil gambar bukti kehadiran."); loading(false); return; }

            // Data Tambahan untuk Pelawat / Manual
            let ver = kat; 
            let ic = "", tuj = "", tel = "", status = "HADIR";

            if(isManual) {
                status = document.getElementById('statusManual').value;
                ver += " (MANUAL: " + status + ")";
            }

            if(kat === 'PELAWAT') {
                ic = document.getElementById('icPelawat').value;
                tuj = document.getElementById('tujuan').value;
                tel = document.getElementById('noTel').value;
                if(!ic || !tuj || !tel) { alert("Sila lengkapkan butiran pelawat."); loading(false); return; }
            }

            loading(true);
            
            // Simpan nama untuk kegunaan masa depan
            localStorage.setItem('savedName', nama);

            let formData = new FormData();
            formData.append('action', 'MASUK');
            formData.append('kategori', kat);
            formData.append('nama', nama);
            formData.append('foto', foto);
            formData.append('lat', lat);
            formData.append('lng', lng);
            formData.append('manual', isManual ? "YA" : "TIDAK");
            // Extra
            formData.append('ic', ic);
            formData.append('tujuan', tuj);
            formData.append('notel', tel);
            formData.append('status', status);

            fetch(API_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading(false);
                if(data.result === 'success') {
                    // --- KOD BARU: LOCAL DEVICE LOCKING (START) ---
                    // Mengunci peranti serta-merta supaya integriti terjaga
                    localStorage.setItem('status_kehadiran', 'MASUK');
                    localStorage.setItem('nama_pengguna_aktif', nama);
                    semakStatusLocalLock(); // Kemaskini UI serta merta
                    // --- KOD BARU: LOCAL DEVICE LOCKING (END) ---

                    showMessage("Berjaya Daftar Masuk!", "success");
                    document.getElementById('nama').value = "";
                    document.getElementById('previewImg').style.display = "none";
                    document.getElementById('base64Foto').value = "";
                    loadList(); // Refresh list bawah
                } else {
                    showMessage("Gagal: " + data.error, "error");
                }
            })
            .catch(error => {
                loading(false);
                // Jika error (Offline), kita anggap success Local Storage (Queue)
                // --- KOD BARU: LOCAL DEVICE LOCKING (START) ---
                localStorage.setItem('status_kehadiran', 'MASUK');
                localStorage.setItem('nama_pengguna_aktif', nama);
                semakStatusLocalLock();
                // --- KOD BARU: LOCAL DEVICE LOCKING (END) ---

                showMessage("Offline: Data disimpan. Anda dikira HADIR.", "success");
            });
        }

        function prosesDaftarKeluar() {
            let nama = localStorage.getItem('savedName');
            // Backup jika localstorage hilang, cuba cari dari 'nama_pengguna_aktif'
            if (!nama) nama = localStorage.getItem('nama_pengguna_aktif');

            if(!nama) { alert("Tiada rekod nama tersimpan."); return; }

            if(!confirm("Adakah anda pasti mahu DAFTAR KELUAR untuk " + nama + "?")) return;

            loading(true);
            let formData = new FormData();
            formData.append('action', 'KELUAR');
            formData.append('nama', nama);

            fetch(API_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                loading(false);
                // --- KOD BARU: UNLOCK DEVICE (START) ---
                localStorage.removeItem('status_kehadiran');
                localStorage.removeItem('nama_pengguna_aktif');
                semakStatusLocalLock(); // Reset UI ke asal
                // --- KOD BARU: UNLOCK DEVICE (END) ---

                alert("Berjaya Daftar Keluar. Terima Kasih.");
                loadList();
            })
            .catch(err => {
                loading(false);
                // --- KOD BARU: UNLOCK DEVICE (OFFLINE) ---
                localStorage.removeItem('status_kehadiran');
                localStorage.removeItem('nama_pengguna_aktif');
                semakStatusLocalLock();
                // --- KOD BARU: UNLOCK DEVICE (END) ---

                alert("Berjaya Keluar (Mod Offline).");
            });
        }

        // ======================================================================
        //                  FUNGSI PAPARAN LIST & LAIN-LAIN
        // ======================================================================
        function loadList() {
            // Kita load list, tapi kita tak bergantung pada list untuk tunjuk butang keluar lagi
            // Butang keluar sekarang dikawal oleh 'semakStatusLocalLock'
            fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                currentList = data; // Simpan untuk rujukan
                renderList(data);
            })
            .catch(e => {
                document.getElementById('listArea').innerHTML = "<div style='color:red; font-size:12px;'>Gagal muat turun senarai (Offline).</div>";
            });
        }

        function renderList(list) {
            let html = "";
            let myName = localStorage.getItem('savedName');
            
            if(list.length === 0) {
                document.getElementById('listArea').innerHTML = "<div style='text-align:center; padding:20px; color:#999; font-size:12px;'>Tiada rekod hari ini.</div>";
                return;
            }

            // Loop semua data (tiada limit 10 dah)
            for(let i = 0; i < list.length; i++) {
                let d = list[i];
                // Kira masa live
                let timeIn = new Date(); 
                // Format masa mudah
                // Anggap d.jam format "HH:mm" atau Date ISO. Kita display text sahaja dari sheet.
                
                html += `
                <div class="list-item">
                    <div style="display:flex; align-items:center;">
                        <img src="${d.foto}" class="avatar" onclick="viewImage(${i})">
                        <div class="list-info">
                            <div class="list-name">${d.nama} <span class="list-cat">${d.kategori}</span></div>
                            <div class="list-time">Masuk: ${formatTime(d.jam)}</div>
                            <div class="live-timer" id="timer-${i}">...</div>
                        </div>
                    </div>
                </div>`;
            }
            document.getElementById('listArea').innerHTML = html;
            updateLiveTimers();
        }

        // Helper mudah format masa
        function formatTime(raw) {
            if(!raw) return "";
            // Cuba parse date string
            let d = new Date(raw);
            if(isNaN(d.getTime())) return raw; // Kalau bukan date, return text asal
            return d.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
        }

        // Fungsi Live Timer (Berapa lama dah masuk)
        function updateLiveTimers() {
            // Kod asal timer anda boleh letak sini jika mahu kompleks
            // Buat masa ini kita biarkan basic
        }

        function viewImage(index) { let data = currentList[index]; if(data && data.foto) { document.getElementById('imgFull').src = data.foto; document.getElementById('imageModal').style.display = "flex"; } }
        function closeModal() { document.getElementById('imageModal').style.display = "none"; }
        function processImage(i){if(i.files&&i.files[0]){let r=new FileReader();r.onload=function(e){let im=new Image();im.src=e.target.result;im.onload=function(){let cv=document.createElement("canvas");let ctx=cv.getContext("2d");cv.width=400;cv.height=400*(im.height/im.width);ctx.drawImage(im,0,0,cv.width,cv.height);let d=cv.toDataURL("image/jpeg",0.7);document.getElementById('previewImg').src=d;document.getElementById('previewImg').style.display='block';document.getElementById('base64Foto').value=d;};};r.readAsDataURL(i.files[0]);}}
        function checkKategori(){ if(document.getElementById('kategori').value==='PELAWAT') showPelawatForm(); else {document.getElementById('pelawatPanel').style.display='none'; document.getElementById('formInputs').style.display='block';} }
        function showPelawatForm(){ document.getElementById('pelawatPanel').style.display='block'; }
        
        function toggleAdmin() {
            let x = document.getElementById('adminPanel');
            if(x.style.display === 'none' || x.style.display === '') x.style.display = 'block';
            else x.style.display = 'none';
        }

        function loading(isLoading) {
            document.getElementById('loader').style.display = isLoading ? 'block' : 'none';
        }
        function showMessage(msg, type) {
            let m = document.getElementById('msgBox');
            m.innerText = msg;
            m.className = "status-box " + type;
            m.style.display = 'block';
            setTimeout(() => m.style.display='none', 5000);
        }

        // Fungsi Haversine (Jarak)
        function getDistance(lat1, lon1, lat2, lon2) {
            var R = 6371e3; 
            var Ï†1 = lat1 * Math.PI/180;
            var Ï†2 = lat2 * Math.PI/180;
            var Î”Ï† = (lat2-lat1) * Math.PI/180;
            var Î”Î» = (lon2-lon1) * Math.PI/180;
            var a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; 
        }

        // ======================================================================
        //     FUNGSI PENTING: SEMAKAN INTEGRITI & DEVICE LOCKING
        // ======================================================================
        function semakStatusLocalLock() {
            var status = localStorage.getItem('status_kehadiran');
            var namaAktif = localStorage.getItem('nama_pengguna_aktif');
            
            var btnKeluar = document.getElementById('btnKeluar');
            var defaultForm = document.getElementById('defaultForm');

            if (status === 'MASUK' && namaAktif) {
                // JIKA STATUS MASUK: Sembunyikan borang, Tunjuk butang Keluar
                if(defaultForm) defaultForm.style.display = 'none';
                if(btnKeluar) {
                    btnKeluar.style.display = 'block';
                    btnKeluar.innerText = "DAFTAR KELUAR (" + namaAktif + ")";
                    btnKeluar.classList.remove("hidden"); // Pastikan class hidden dibuang
                }
            } else {
                // JIKA BELUM MASUK: Tunjuk borang, Sorok butang Keluar
                if(defaultForm) defaultForm.style.display = 'block';
                if(btnKeluar) {
                    btnKeluar.style.display = 'none';
                    btnKeluar.classList.add("hidden");
                }
            }
        }

        // Panggil fungsi ini sebaik sahaja page loading
        window.addEventListener('load', () => {
            semakStatusLocalLock(); // Semak status kunci dulu
            loadList(); // Baru load senarai
            
            // Masukkan semula nama terakhir digunakan ke dalam input nama (jika ada)
            let lastUsedName = localStorage.getItem('savedName');
            if(lastUsedName) document.getElementById('nama').value = lastUsedName;
        });

    </script>
</body>
</html>

