// Cikgu AI: Ini adalah otak aplikasi kita. 
// Kita guna pembolehubah global untuk simpan data sementara.
let templateImage = null;
let excelData = [];
let fieldCoordinates = {}; // Menyimpan posisi { 'Nama': {x: 10, y: 20}, ... }
let currentFontSize = 24;
let currentColor = '#000000';

// DOM Elements
const inputTemplate = document.getElementById('input-template');
const inputExcel = document.getElementById('input-excel');
const templatePreview = document.getElementById('template-preview');
const emptyState = document.getElementById('empty-state');
const layerText = document.getElementById('layer-text');
const fieldListDiv = document.getElementById('field-list');
const printArea = document.getElementById('print-area');
const btnPrint = document.getElementById('btn-print-main');

// 1. FUNGSI UPLOAD TEMPLATE
inputTemplate.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      templateImage = event.target.result;
      templatePreview.src = templateImage;
      templatePreview.classList.remove('hidden');
      emptyState.classList.add('hidden');
      checkReady();
    };
    reader.readAsDataURL(file);
  }
});

// 2. FUNGSI BACA EXCEL
inputExcel.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      // Tukar sheet kepada JSON
      excelData = XLSX.utils.sheet_to_json(sheet);

      if (excelData.length > 0) {
        generateFields(excelData[0]);
        checkReady();
      } else {
        alert('Excel kosong!');
      }
    };
    reader.readAsArrayBuffer(file);
  }
});

// 3. GENERATE FIELD DARI HEADER EXCEL
function generateFields(firstRow) {
  fieldListDiv.innerHTML = '';
  layerText.innerHTML = '';
  
  // Dapatkan kunci (header) dari baris pertama
  const headers = Object.keys(firstRow);
  
  headers.forEach((header, index) => {
    // A. Update UI Senarai Field (Kiri)
    const badge = document.createElement('span');
    badge.className = 'px-2 py-1 bg-blue-600 rounded text-xs text-white';
    badge.innerText = header;
    fieldListDiv.appendChild(badge);

    // B. Cipta Elemen Draggable (Kanan/Preview)
    createDraggableElement(header, index);
  });
}

// 4. CIPTA ELEMEN DRAGGABLE
function createDraggableElement(text, index) {
  const div = document.createElement('div');
  div.className = 'draggable-item absolute font-bold';
  div.style.top = (10 + (index * 5)) + '%'; // Jarakkan sikit setiap satu
  div.style.left = '10%';
  div.style.fontSize = currentFontSize + 'px';
  div.style.color = currentColor;
  div.innerText = `{${text}}`; // Papar placeholder
  div.id = `field-${text}`;
  
  // Logic Drag n Drop Mouse
  let isDragging = false;
  let offsetX, offsetY;

  div.addEventListener('mousedown', (e) => {
    isDragging = true;
    // Kira offset cursor dari bucu elemen
    offsetX = e.clientX - div.getBoundingClientRect().left;
    offsetY = e.clientY - div.getBoundingClientRect().top;
    div.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    
    const containerRect = layerText.getBoundingClientRect();
    
    // Kira posisi relative kepada container
    let x = e.clientX - containerRect.left - offsetX;
    let y = e.clientY - containerRect.top - offsetY;

    div.style.left = x + 'px';
    div.style.top = y + 'px';
    
    // Simpan koordinat (peratusan supaya responsive bila print)
    // Cikgu AI: Kita simpan dalam unit 'px' untuk print layout A4 yang fix
    fieldCoordinates[text] = { left: x, top: y };
  });

  document.addEventListener('mouseup', () => {
    if(isDragging) {
        isDragging = false;
        div.style.cursor = 'grab';
    }
  });

  layerText.appendChild(div);
  
  // Initialize coordinate awal
  fieldCoordinates[text] = {
      left: layerText.offsetWidth * 0.1,
      top: layerText.offsetHeight * (0.1 + (index * 0.05))
  };
}

// 5. UPDATE STYLE (Font/Color)
document.getElementById('font-size-control').addEventListener('input', (e) => {
    currentFontSize = e.target.value;
    document.querySelectorAll('.draggable-item').forEach(el => {
        el.style.fontSize = currentFontSize + 'px';
    });
});

document.getElementById('color-control').addEventListener('input', (e) => {
    currentColor = e.target.value;
    document.querySelectorAll('.draggable-item').forEach(el => {
        el.style.color = currentColor;
    });
});

// 6. CHECK READY UNTUK PRINT
function checkReady() {
    if (templateImage && excelData.length > 0) {
        btnPrint.disabled = false;
        btnPrint.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

// 7. LOGIC PRINT (GENERATE PAGES)
// Cikgu AI: Ini bahagian paling penting. Kita akan loop excelData dan bina page HTML sebenar.
window.onbeforeprint = function() {
    printArea.innerHTML = ''; // Kosongkan dulu

    // Loop semua data murid
    excelData.forEach((row) => {
        // Cipta wrapper page (A4)
        const page = document.createElement('div');
        page.className = 'sijil-page relative bg-white overflow-hidden';
        
        // Masukkan Gambar Background
        const img = document.createElement('img');
        img.src = templateImage;
        img.className = 'absolute inset-0 w-full h-full object-cover';
        page.appendChild(img);

        // Masukkan Data Teks mengikut koordinat yang diset
        Object.keys(fieldCoordinates).forEach(key => {
            if (row[key]) { // Jika data wujud dalam row Excel
                const coords = fieldCoordinates[key];
                const textSpan = document.createElement('div');
                textSpan.style.position = 'absolute';
                textSpan.style.left = coords.left + 'px';
                textSpan.style.top = coords.top + 'px';
                textSpan.style.fontSize = currentFontSize + 'px';
                textSpan.style.color = currentColor;
                textSpan.style.fontWeight = 'bold';
                textSpan.style.zIndex = '10';
                textSpan.innerText = row[key]; // Masukkan data sebenar
                page.appendChild(textSpan);
            }
        });

        printArea.appendChild(page);
    });
};

window.onafterprint = function() {
    // Bersihkan memori jika perlu, atau biar user print lagi
    console.log('Cetakan selesai');
};
