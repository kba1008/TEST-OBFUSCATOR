<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azan Pro Malaysia</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: white;
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .active-prayer {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(37, 99, 235, 0.2));
            border: 1px solid rgba(56, 189, 248, 0.5);
            transform: scale(1.02);
        }

        .glow-text {
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center">

    <div class="w-full max-w-md mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold tracking-tight text-sky-400">AZAN PRO</h1>
            <p id="current-date" class="text-xs text-slate-400 uppercase tracking-widest leading-loose"></p>
        </div>
        <button id="gps-btn" class="bg-slate-800 hover:bg-sky-600 p-3 rounded-2xl transition-all duration-300 border border-slate-700 shadow-lg group">
            <i class="fa-solid fa-location-crosshairs group-active:rotate-180 transition-transform"></i>
        </button>
    </div>

    <div class="w-full max-w-md glass-card rounded-[2.5rem] p-8 mb-6 text-center">
        <p id="next-prayer-label" class="text-slate-400 text-sm font-medium mb-1">Menunggu Data...</p>
        <h2 id="next-prayer-name" class="text-5xl font-extrabold mb-4 glow-text tracking-tight">-</h2>
        <div class="inline-flex items-center bg-slate-900/50 px-6 py-2 rounded-full border border-slate-700">
            <span id="countdown" class="text-2xl font-mono font-bold text-sky-400">00:00:00</span>
        </div>
        
        <div class="mt-8 flex flex-col gap-2">
            <select id="zone-selector" class="w-full bg-slate-800/80 border border-slate-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-sky-500 outline-none transition-all cursor-pointer">
                </select>
            <p id="location-name" class="text-[10px] text-slate-500 italic mt-1 px-2"></p>
        </div>
    </div>

    <div class="w-full max-w-md space-y-3" id="prayer-list">
        </div>

    <audio id="azan-player">
        <source src="https://www.islamcan.com/common/azan/azan1.mp3" type="audio/mpeg">
    </audio>

    <footer class="mt-8 text-slate-500 text-[10px] flex items-center gap-2">
        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
        Data Rasmi JAKIM & e-Solat API
    </footer>

    <script>
        const JAKIM_ZONES = [
            { code: 'JHR01', name: 'Johor: P. Aur & Pemanggil', lat: 2.45, lon: 104.51 },
            { code: 'JHR02', name: 'Johor: JB, Kota Tinggi, Mersing', lat: 1.49, lon: 103.76 },
            { code: 'JHR03', name: 'Johor: Kluang, Pontian', lat: 2.03, lon: 103.32 },
            { code: 'JHR04', name: 'Johor: Batu Pahat, Muar, Segamat', lat: 1.85, lon: 102.93 },
            { code: 'KDH01', name: 'Kedah: Kota Setar, Kubang Pasu', lat: 6.12, lon: 100.37 },
            { code: 'KDH02', name: 'Kedah: Kuala Muda, Yan, Pendang', lat: 5.64, lon: 100.49 },
            { code: 'KDH03', name: 'Kedah: Padang Terap, Sik', lat: 6.25, lon: 100.67 },
            { code: 'KDH04', name: 'Kedah: Baling', lat: 5.68, lon: 100.92 },
            { code: 'KDH05', name: 'Kedah: Kulim, Bandar Baharu', lat: 5.37, lon: 100.55 },
            { code: 'KDH06', name: 'Kedah: Langkawi', lat: 6.35, lon: 99.80 },
            { code: 'KDH07', name: 'Kedah: Gunung Jerai', lat: 5.80, lon: 100.43 },
            { code: 'KTN01', name: 'Kelantan: Kota Bharu, Pasir Mas', lat: 6.12, lon: 102.24 },
            { code: 'KTN02', name: 'Kelantan: Gua Musang, Jeli', lat: 4.88, lon: 101.96 },
            { code: 'MLK01', name: 'Melaka: Seluruh Negeri', lat: 2.19, lon: 102.25 },
            { code: 'NGS01', name: 'N.Sembilan: Tampin, Jempol', lat: 2.48, lon: 102.23 },
            { code: 'NGS02', name: 'N.Sembilan: Jelebu, Kuala Pilah', lat: 2.73, lon: 102.25 },
            { code: 'NGS03', name: 'N.Sembilan: Port Dickson, Seremban', lat: 2.72, lon: 101.94 },
            { code: 'PHG01', name: 'Pahang: Pulau Tioman', lat: 2.81, lon: 104.17 },
            { code: 'PHG02', name: 'Pahang: Kuantan, Pekan, Rompin', lat: 3.81, lon: 103.33 },
            { code: 'PHG03', name: 'Pahang: Jerantut, Temerloh, Maran', lat: 3.93, lon: 102.35 },
            { code: 'PHG04', name: 'Pahang: Bentong, Lipis, Raub', lat: 3.52, lon: 101.91 },
            { code: 'PHG05', name: 'Pahang: Genting Sempah, Janda Baik', lat: 3.35, lon: 101.76 },
            { code: 'PHG06', name: 'Pahang: Cameron Highlands, Fraser', lat: 4.47, lon: 101.38 },
            { code: 'PRK01', name: 'Perak: Tapah, Slim River, Tg Malim', lat: 4.18, lon: 101.26 },
            { code: 'PRK02', name: 'Perak: Ipoh, Batu Gajah, Kampar', lat: 4.59, lon: 101.07 },
            { code: 'PRK03', name: 'Perak: Grik, Lenggong', lat: 5.43, lon: 101.13 },
            { code: 'PRK04', name: 'Perak: Temengor, Belum', lat: 5.60, lon: 101.30 },
            { code: 'PRK05', name: 'Perak: Teluk Intan, Lumut', lat: 4.00, lon: 101.02 },
            { code: 'PRK06', name: 'Perak: Taiping, Selama, Parit Buntar', lat: 4.85, lon: 100.73 },
            { code: 'PRK07', name: 'Perak: Bukit Larut', lat: 4.86, lon: 100.79 },
            { code: 'PLS01', name: 'Perlis: Seluruh Negeri', lat: 6.44, lon: 100.20 },
            { code: 'PNG01', name: 'P.Pinang: Seluruh Negeri', lat: 5.41, lon: 100.33 },
            { code: 'SBH01', name: 'Sabah: Sandakan (Timur)', lat: 5.84, lon: 118.11 },
            { code: 'SBH02', name: 'Sabah: Sandakan (Barat)', lat: 5.34, lon: 117.08 },
            { code: 'SBH03', name: 'Sabah: Lahad Datu, Semporna', lat: 5.03, lon: 118.33 },
            { code: 'SBH04', name: 'Sabah: Tawau', lat: 4.24, lon: 117.89 },
            { code: 'SBH05', name: 'Sabah: Kudat', lat: 6.88, lon: 116.82 },
            { code: 'SBH06', name: 'Sabah: Gunung Kinabalu', lat: 6.07, lon: 116.56 },
            { code: 'SBH07', name: 'Sabah: Kota Kinabalu, Papar', lat: 5.98, lon: 116.07 },
            { code: 'SBH08', name: 'Sabah: Keningau, Tambunan', lat: 5.33, lon: 116.13 },
            { code: 'SBH09', name: 'Sabah: Beaufort, Sipitang', lat: 5.34, lon: 115.74 },
            { code: 'SWK01', name: 'Sarawak: Limbang, Lawas', lat: 4.75, lon: 115.00 },
            { code: 'SWK02', name: 'Sarawak: Miri', lat: 4.41, lon: 114.00 },
            { code: 'SWK03', name: 'Sarawak: Bintulu', lat: 3.17, lon: 113.03 },
            { code: 'SWK04', name: 'Sarawak: Sibu, Kapit', lat: 2.29, lon: 111.83 },
            { code: 'SWK05', name: 'Sarawak: Sarikei', lat: 2.12, lon: 111.52 },
            { code: 'SWK06', name: 'Sarawak: Sri Aman, Saratok', lat: 1.23, lon: 111.46 },
            { code: 'SWK07', name: 'Sarawak: Serian, Simunjan', lat: 1.17, lon: 110.57 },
            { code: 'SWK08', name: 'Sarawak: Kuching, Bau', lat: 1.55, lon: 110.33 },
            { code: 'SWK09', name: 'Sarawak: Zon Khas', lat: 1.15, lon: 110.45 },
            { code: 'SGR01', name: 'Selangor: Gombak, Petaling, Sepang', lat: 3.12, lon: 101.55 },
            { code: 'SGR02', name: 'Selangor: Klang, Kuala Langat', lat: 3.05, lon: 101.45 },
            { code: 'SGR03', name: 'Selangor: Kuala Selangor, Sabak Bernam', lat: 3.34, lon: 101.25 },
            { code: 'TRG01', name: 'Terengganu: K.Terengganu, Marang', lat: 5.33, lon: 103.14 },
            { code: 'TRG02', name: 'Terengganu: Besut, Setiu', lat: 5.77, lon: 102.50 },
            { code: 'TRG03', name: 'Terengganu: Hulu Terengganu', lat: 5.10, lon: 102.90 },
            { code: 'TRG04', name: 'Terengganu: Dungun, Kemaman', lat: 4.75, lon: 103.40 },
            { code: 'WST01', name: 'WP: Kuala Lumpur & Putrajaya', lat: 3.14, lon: 101.69 },
            { code: 'WST02', name: 'WP: Labuan', lat: 5.28, lon: 115.24 }
        ];

        let currentPrayerData = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            setupZoneSelector();
            updateDateTime();
            
            const savedZone = localStorage.getItem('selectedZone') || 'WST01';
            loadPrayerTimes(savedZone);
            
            setInterval(updateDateTime, 1000);
            setInterval(checkPrayerTime, 1000);
        });

        function setupZoneSelector() {
            const selector = document.getElementById('zone-selector');
            JAKIM_ZONES.sort((a,b) => a.name.localeCompare(b.name)).forEach(z => {
                const opt = document.createElement('option');
                opt.value = z.code;
                opt.textContent = `${z.code} - ${z.name}`;
                selector.appendChild(opt);
            });

            selector.addEventListener('change', (e) => loadPrayerTimes(e.target.value));
        }

        async function loadPrayerTimes(zoneCode) {
            try {
                const res = await fetch(`https://api.waktusolat.app/v2/solat/${zoneCode}`);
                const data = await res.json();
                currentPrayerData = data.prayers[0]; // Get today
                localStorage.setItem('selectedZone', zoneCode);
                document.getElementById('zone-selector').value = zoneCode;
                renderPrayerList();
            } catch (err) {
                console.error("Gagal ambil data:", err);
            }
        }

        function renderPrayerList() {
            if (!currentPrayerData) return;
            const list = document.getElementById('prayer-list');
            list.innerHTML = '';
            
            const prayers = [
                { id: 'fajr', label: 'Subuh', icon: 'fa-cloud-moon' },
                { id: 'syuruk', label: 'Syuruk', icon: 'fa-sun' },
                { id: 'dhuhr', label: 'Zohor', icon: 'fa-certificate' },
                { id: 'asr', label: 'Asar', icon: 'fa-cloud-sun' },
                { id: 'maghrib', label: 'Maghrib', icon: 'fa-moon' },
                { id: 'isha', label: 'Isyak', icon: 'fa-stars' }
            ];

            prayers.forEach(p => {
                const timeStr = formatTime(currentPrayerData[p.id]);
                const div = document.createElement('div');
                div.id = `card-${p.id}`;
                div.className = 'flex justify-between items-center bg-slate-800/40 p-4 rounded-2xl border border-slate-700/50 transition-all';
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-slate-700 flex items-center justify-center">
                            <i class="fa-solid ${p.icon} text-sky-400"></i>
                        </div>
                        <span class="font-semibold text-slate-200">${p.label}</span>
                    </div>
                    <span class="text-xl font-mono font-bold tracking-tighter text-slate-300">${timeStr}</span>
                `;
                list.appendChild(div);
            });
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit', hour12: true }).toUpperCase();
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('current-date').innerText = now.toLocaleDateString('ms-MY', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
            });
            
            if (currentPrayerData) updateCountdown();
        }

        function updateCountdown() {
            const now = Math.floor(Date.now() / 1000);
            const prayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
            
            let nextPrayer = null;
            for (let p of prayers) {
                if (currentPrayerData[p] > now) {
                    nextPrayer = { name: p.charAt(0).toUpperCase() + p.slice(1), time: currentPrayerData[p] };
                    break;
                }
            }

            // If no more prayers today, look for tomorrow's Fajr (simplified for UI)
            if (!nextPrayer) {
                document.getElementById('next-prayer-label').innerText = "Selesai Solat Hari Ini";
                document.getElementById('next-prayer-name').innerText = "Rehat";
                document.getElementById('countdown').innerText = "00:00:00";
                return;
            }

            const diff = nextPrayer.time - now;
            const h = Math.floor(diff / 3600).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');

            document.getElementById('next-prayer-label').innerText = "Seterusnya";
            document.getElementById('next-prayer-name').innerText = nextPrayer.name;
            document.getElementById('countdown').innerText = `${h}:${m}:${s}`;
        }

        function checkPrayerTime() {
            if (!currentPrayerData) return;
            const now = Math.floor(Date.now() / 1000);
            const prayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];

            prayers.forEach(p => {
                if (Math.abs(currentPrayerData[p] - now) < 1) {
                    playAzan();
                }
            });
        }

        function playAzan() {
            const player = document.getElementById('azan-player');
            player.play().catch(e => console.log("Perlukan interaksi pengguna untuk audio."));
            alert("Masuk Waktu Solat!");
        }

        // GPS Logic: Haversine Formula
        document.getElementById('gps-btn').addEventListener('click', () => {
            if (!navigator.geolocation) return alert("GPS tidak disokong.");
            
            document.getElementById('gps-btn').classList.add('animate-spin');
            
            navigator.geolocation.getCurrentPosition(pos => {
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;
                
                let closest = null;
                let minDist = Infinity;

                JAKIM_ZONES.forEach(z => {
                    const dist = getDistance(userLat, userLon, z.lat, z.lon);
                    if (dist < minDist) {
                        minDist = dist;
                        closest = z;
                    }
                });

                if (closest) {
                    loadPrayerTimes(closest.code);
                    document.getElementById('location-name').innerText = `Dikesan: ${closest.name} (Ketepatan Tinggi)`;
                }
                document.getElementById('gps-btn').classList.remove('animate-spin');
            }, err => {
                alert("Gagal mengesan lokasi. Sila pilih manual.");
                document.getElementById('gps-btn').classList.remove('animate-spin');
            }, { enableHighAccuracy: true });
        });

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius bumi (KM)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
